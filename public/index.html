<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROI Analysis & Pricing Estimate Model - SAX Technology Advisors</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }
        
        .main-layout {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .container {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: 100%;
        }
        
        .chat-container {
            width: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .chat-header h3 {
            margin-bottom: 5px;
        }
        
        .chat-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 280px);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }
        
        .message.assistant {
            background: #f1f8e9;
            margin-right: auto;
            border-bottom-left-radius: 3px;
        }
        
        .message.system {
            background: #fff3e0;
            margin: 0 auto;
            text-align: center;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .message-content {
            line-height: 1.4;
        }
        
        .typing-indicator {
            display: none;
            background: #f1f8e9;
            margin-right: auto;
            border-bottom-left-radius: 3px;
            padding: 10px 15px;
            max-width: 85%;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid #eee;
            border-radius: 0 0 15px 15px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            font-family: inherit;
            outline: none;
        }
        
        .chat-input textarea:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }
        
        .send-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .send-btn:hover {
            background: #218838;
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .quick-action {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action:hover {
            background: #28a745;
            color: white;
        }
        
        /* Authentication Status Box */
        .auth-status-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: Arial, sans-serif;
            font-size: 13px;
            z-index: 10000;
            max-width: 300px;
            min-width: 250px;
        }
        
        .auth-status-box h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .auth-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .auth-status-indicator.authenticated {
            color: #27ae60;
        }
        
        .auth-status-indicator.not-authenticated {
            color: #e74c3c;
        }
        
        .auth-user-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .auth-sign-out-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .auth-sign-out-btn:hover {
            background: #c0392b;
        }
        
        .auth-sign-in-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.2s;
        }
        
        .auth-sign-in-btn:hover {
            background: #2980b9;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-content {
            flex: 1;
            text-align: center;
        }
        
        .logo-container {
            width: 400px;
            height: 240px;
            background: transparent;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 30px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .logo-placeholder {
            color: #999;
            font-size: 0.9em;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .logo-placeholder::before {
            content: "üè¢";
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }
        
        .logo-upload {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: #f8f9fa;
            padding: 15px;
            margin: -30px -30px 20px;
            font-size: 1.5em;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }
        
        .config-panel {
            background: #e7f3ff;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
        }
        
        .config-item label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .config-item input, .config-item select {
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .role-config-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        
        .role-config-table th {
            background: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .role-config-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .role-config-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        td input {
            width: 100%;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .highlight {
            background: #fff3cd;
            font-weight: bold;
        }
        
        .savings {
            background: #d4edda;
            font-weight: bold;
        }
        
        .cost {
            background: #f8d7da;
        }
        
        .metric-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #3498db;
        }
        
        .metric-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .roi-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
        }
        
        .roi-summary h2 {
            margin-bottom: 20px;
        }
        
        .roi-summary .metric-value {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
        }
        
        .pricing-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .pricing-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .pricing-card.recommended {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .pricing-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .price {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin: 15px 0;
        }
        
        .price-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            color: #333;
        }
        
        .note {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .btn-update, .btn-print {
            background: #3498db;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
        }
        
        .btn-update:hover, .btn-print:hover {
            background: #2980b9;
        }
        
        .btn-print {
            background: #27ae60;
        }
        
        .btn-print:hover {
            background: #229954;
        }
        
        .btn-add, .btn-remove {
            padding: 5px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 0.9em;
        }
        
        .btn-add {
            background: #27ae60;
            color: white;
        }
        
        .btn-add:hover {
            background: #229954;
        }
        
        .btn-remove {
            background: #e74c3c;
            color: white;
        }
        
        .btn-remove:hover {
            background: #c0392b;
        }
        
        .workflow-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .workflow-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .ai-pricing-table {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .ai-model-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .ai-model-option {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .ai-model-option.selected {
            border-color: #3498db;
            background: #e7f3ff;
        }
        
        .token-calculator {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .token-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .risk-summary {
            background: #d4edda;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .risk-summary h3 {
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
                height: auto;
            }
            
            .chat-container {
                width: 100%;
                order: -1;
                max-height: 400px;
            }
        }
        
        @media print {
            .chat-container, .config-panel, .btn-update, .btn-print, .workflow-section, .btn-add, .btn-remove, .logo-upload {
                display: none !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 12px !important;
            }
            
            .main-layout {
                max-width: none !important;
                width: 100% !important;
                flex-direction: column !important;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
                width: 100% !important;
            }
            
            .section {
                page-break-inside: avoid;
                margin-bottom: 20px !important;
            }
            
            .section-title {
                margin: 0 0 15px 0 !important;
                font-size: 1.2em !important;
            }
            
            table {
                font-size: 11px !important;
                margin: 10px 0 !important;
            }
            
            th, td {
                padding: 6px 8px !important;
            }
            
            .roi-summary {
                page-break-inside: avoid;
                margin: 15px 0 !important;
                padding: 20px !important;
            }
            
            .pricing-options {
                display: block !important;
            }
            
            .pricing-card {
                display: inline-block !important;
                width: 30% !important;
                margin: 1% !important;
                vertical-align: top;
                page-break-inside: avoid;
            }
            
            .metric-cards {
                display: block !important;
            }
            
            .metric-card {
                display: inline-block !important;
                width: 30% !important;
                margin: 1% !important;
                vertical-align: top;
            }
            
            h1 { font-size: 1.8em !important; }
            h2 { font-size: 1.4em !important; }
            h3 { font-size: 1.2em !important; }
            
            /* Force show all sections in print */
            .section, .roi-summary, .pricing-options, .metric-cards {
                display: block !important;
                visibility: visible !important;
            }
        }
    </style>
</head>
<body>
    <script>
        // Client-side authentication enforcement
        (function() {
            async function checkAuth() {
                try {
                    const response = await fetch('/.auth/me');
                    const data = await response.json();
                    
                    // If no authenticated user, redirect to login
                    if (!data.clientPrincipal || !data.clientPrincipal.userDetails) {
                        console.log('User not authenticated, redirecting to login...');
                        window.location.href = '/.auth/login/aad?post_login_redirect_uri=' + encodeURIComponent(window.location.href);
                        return false;
                    }
                    
                    console.log('User authenticated:', data.clientPrincipal.userDetails);
                    return true;
                } catch (error) {
                    console.error('Auth check failed:', error);
                    // On error, assume not authenticated and redirect
                    window.location.href = '/.auth/login/aad?post_login_redirect_uri=' + encodeURIComponent(window.location.href);
                    return false;
                }
            }
            
            // Check authentication immediately
            checkAuth().then(isAuthenticated => {
                if (isAuthenticated) {
                    // Show the page content
                    document.body.style.visibility = 'visible';
                } else {
                    // Hide content while redirecting
                    document.body.style.visibility = 'hidden';
                }
            });
            
            // Hide content initially until auth check completes
            document.body.style.visibility = 'hidden';
        })();
    </script>
    <div class="main-layout">
        <div class="container">
            <div class="header">
                <div class="logo-container">
                    <input type="file" class="logo-upload" accept="image/*" onchange="uploadLogo(event)">
                    <img id="logoImg" src="logo.png" alt="SAXTech Logo" style="display: block; width: 100%; height: 100%; object-fit: contain;">
                    <div class="logo-placeholder" id="logoPlaceholder" style="display: none;">
                        <div>Your Company Logo</div>
                        <small>Click to upload or edit HTML</small>
                    </div>
                </div>
                <div class="header-content">
                    <h1><span id="clientName">Your Company</span> <span id="processName">Process Name</span> Automation</h1>
                    <p>ROI Analysis & Pricing Estimate Model - SAX Technology Advisors</p>
                </div>
            </div>
            
            <div class="content">
                <!-- Configuration Panel -->
                <div class="config-panel">
                    <h3>üìä Customize Analysis Parameters</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn-update" onclick="saveConfiguration()" style="margin: 5px;">üíæ Save Configuration</button>
                        <input type="file" id="loadFile" accept=".json" style="display: none;" onchange="loadConfiguration(event)">
                        <button class="btn-update" onclick="document.getElementById('loadFile').click()" style="margin: 5px;">üìÅ Load Configuration</button>
                        <button class="btn-update" onclick="loadSampleCompany()" style="margin: 5px;">üè¢ Sample Company</button>
                        <button class="btn-print" onclick="resetToDefaults()" style="margin: 5px;">üîÑ Reset to Defaults</button>
                    </div>
                    
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Client Name:</label>
                            <input type="text" id="inputClientName" value="Your Company" onchange="updateCalculations()">
                        </div>
                        <div class="config-item">
                            <label>Process Name:</label>
                            <input type="text" id="inputProcessName" value="Process Name" onchange="updateCalculations()">
                        </div>
                        <div class="config-item">
                            <label>Monthly Volume:</label>
                            <input type="number" id="monthlyVolume" value="10" onchange="updateCalculations()">
                        </div>
                        <div class="config-item">
                            <label>Fully Burdened Cost % (above base salary):</label>
                            <input type="number" id="burdenPercent" value="35" step="1" onchange="updateRoles()">
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px;">Define Roles & Costs</h4>
                    <table class="role-config-table" id="roleTable">
                        <thead>
                            <tr>
                                <th>Role Title</th>
                                <th>Base Salary</th>
                                <th>Fully Burdened Cost</th>
                                <th>Hourly Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roleTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                    <button class="btn-add" onclick="addRole()">+ Add Role</button>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-update" onclick="updateCalculations()">üîÑ Update All Calculations</button>
                        <button class="btn-print" onclick="printToPDF()">üñ®Ô∏è Print to PDF</button>
                        <button class="btn-update" onclick="validateROIAnalysis()" style="margin: 5px; background: #28a745;">‚úì Validate Analysis</button>
                        <button class="btn-update" onclick="generateSOP()" style="margin: 5px; background: #17a2b8;">üìã Generate SOP</button>
                        <button class="btn-update" onclick="startOverChat()" style="margin: 5px; background: #e74c3c;">üîÑ Start Over Chat</button>
                    </div>
                </div>
                
                <!-- Executive Summary -->
                <div class="roi-summary">
                    <h2>Executive Summary</h2>
                    <div class="metric-cards" style="color: white;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px;">
                            <div class="metric-value">$<span id="annualSavings">156,000</span></div>
                            <div style="font-weight: 600;">Annual Labor Cost Savings</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px;">
                            <div class="metric-value"><span id="timeReduction">91.7</span>%</div>
                            <div style="font-weight: 600;">Time Reduction</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px;">
                            <div class="metric-value"><span id="paybackPeriod">2.8</span> Months</div>
                            <div style="font-weight: 600;">Payback Period</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px;">
                            <div class="metric-value"><span id="firstYearROI">292</span>%</div>
                            <div style="font-weight: 600;">First Year ROI</div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Process Analysis -->
                <div class="section">
                    <h2 class="section-title">1. Current Manual Process Analysis</h2>
                    
                    <table id="manualProcessTable">
                        <thead>
                            <tr>
                                <th>Process Step</th>
                                <th>Role</th>
                                <th>Hourly Cost</th>
                                <th>Time (Minutes)</th>
                                <th>Cost per Process</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manualProcessBody">
                            <!-- Dynamic rows will be here -->
                        </tbody>
                    </table>
                    <button class="btn-add" onclick="addManualStep()">+ Add Process Step</button>
                    
                    <div class="note">
                        <strong>Key Assumptions:</strong>
                        <ul style="margin-left: 20px; margin-top: 10px;" id="roleAssumptions">
                            <!-- Dynamic role assumptions will be here -->
                        </ul>
                    </div>
                </div>
                
                <!-- AI Pricing Configuration -->
                <div class="section">
                    <h2 class="section-title">AI Model Configuration & Pricing</h2>
                    
                    <div class="ai-pricing-table">
                        <h3>Select Azure OpenAI Model</h3>
                        <div class="ai-model-selector">
                            <div class="ai-model-option selected" onclick="selectAIModel('gpt4-mini', this)">
                                <h4>GPT-4.0 Mini</h4>
                                <p><strong>Input:</strong> $0.15 / 1M tokens</p>
                                <p><strong>Output:</strong> $0.60 / 1M tokens</p>
                                <p>Fast, cost-effective for most automation</p>
                            </div>
                            <div class="ai-model-option" onclick="selectAIModel('gpt41-mini', this)">
                                <h4>GPT-4.1 Mini</h4>
                                <p><strong>Input:</strong> $0.30 / 1M tokens</p>
                                <p><strong>Output:</strong> $1.20 / 1M tokens</p>
                                <p>Enhanced capabilities, better reasoning</p>
                            </div>
                            <div class="ai-model-option" onclick="selectAIModel('gpt5', this)">
                                <h4>GPT-5</h4>
                                <p><strong>Input:</strong> $25 / 1M tokens</p>
                                <p><strong>Output:</strong> $75 / 1M tokens</p>
                                <p>Next-gen capabilities</p>
                            </div>
                        </div>
                        
                        <div class="token-calculator">
                            <div class="token-info">
                                <strong>Token Guide:</strong><br>
                                ‚Ä¢ <strong>Input Tokens:</strong> The text/data you send to the AI (prompts, context, documents)<br>
                                ‚Ä¢ <strong>Output Tokens:</strong> The AI's response (analysis, generated content, decisions)<br>
                                ‚Ä¢ <strong>1 token ‚âà 4 characters</strong> or about 0.75 words<br>
                                ‚Ä¢ <strong>AI Calls:</strong> Number of times AI is invoked per process (validation, assessment, etc.)
                            </div>
                            
                            <h4>Token Usage Estimator</h4>
                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Avg Document/Form Size (pages):</label>
                                    <input type="number" id="docPages" value="3" onchange="estimateTokens()">
                                </div>
                                <div class="config-item">
                                    <label>Complexity Level:</label>
                                    <select id="complexity" onchange="estimateTokens()">
                                        <option value="simple">Simple (validation only)</option>
                                        <option value="medium" selected>Medium (analysis + decision)</option>
                                        <option value="complex">Complex (deep reasoning)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="config-grid" style="margin-top: 20px;">
                            <div class="config-item">
                                <label>Avg Input Tokens per Process:</label>
                                <input type="number" id="inputTokens" value="3000" onchange="updateAIPricing()">
                            </div>
                            <div class="config-item">
                                <label>Avg Output Tokens per Process:</label>
                                <input type="number" id="outputTokens" value="1500" onchange="updateAIPricing()">
                            </div>
                            <div class="config-item">
                                <label>AI Calls per Process:</label>
                                <input type="number" id="aiCalls" value="3" onchange="updateAIPricing()">
                            </div>
                            <div class="config-item">
                                <label>Cost per Process:</label>
                                <div style="font-size: 1.5em; color: #3498db; font-weight: bold;">$<span id="aiCostPerProcess">0.00</span></div>
                            </div>
                        </div>
                        
                        <div class="formula">
                            <strong>Token Usage Calculation:</strong><br>
                            Input Cost: (<span id="calcInputTokens">3000</span> tokens √ó <span id="calcAICalls">3</span> calls) √ó $<span id="calcInputPrice">0.00015</span> = $<span id="calcInputCost">0.00</span><br>
                            Output Cost: (<span id="calcOutputTokens">1500</span> tokens √ó <span id="calcAICalls2">3</span> calls) √ó $<span id="calcOutputPrice">0.0006</span> = $<span id="calcOutputCost">0.00</span><br>
                            <strong>Total per Process: $<span id="calcTotalCost">0.00</span></strong><br>
                            <strong>Monthly (<span class="monthly-volume">20</span> processes): $<span id="calcMonthlyCost">0.00</span></strong><br>
                            <strong>Annual (<span class="annual-volume">240</span> processes): $<span id="calcAnnualCost">0.00</span></strong>
                        </div>
                    </div>
                </div>
                
                <!-- Automated Process Analysis -->
                <div class="section">
                    <h2 class="section-title">2. Automated Process with SAXTech Automation Solution</h2>
                    
                    <table id="automatedProcessTable">
                        <thead>
                            <tr>
                                <th>Automated Step</th>
                                <th>Human Involvement</th>
                                <th>Time (Minutes)</th>
                                <th>Cost per Process</th>
                                <th>Automation Feature</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="automatedProcessBody">
                            <!-- Dynamic rows will be here -->
                        </tbody>
                    </table>
                    <button class="btn-add" onclick="addAutomatedStep()">+ Add Automated Step</button>
                    
                    <div class="metric-cards">
                        <div class="metric-card">
                            <h3>Time Savings</h3>
                            <div class="metric-value"><span id="timeSavingsPercent">91.7</span>%</div>
                            <div class="metric-label"><span id="timeSavingsMinutes">373</span> minutes saved per process</div>
                        </div>
                        <div class="metric-card">
                            <h3>Cost Savings</h3>
                            <div class="metric-value">$<span id="costSavingsPerClient">543.68</span></div>
                            <div class="metric-label">Per process instance</div>
                        </div>
                        <div class="metric-card">
                            <h3>Processing Speed</h3>
                            <div class="metric-value"><span id="speedImprovement">15</span>x Faster</div>
                            <div class="metric-label">From <span id="oldHours">6.67</span> hrs to <span id="newMinutes">27</span> min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Implementation Cost Calculator -->
                <div class="section">
                    <h2 class="section-title">Implementation Cost Calculator</h2>
                    
                    <div class="config-panel">
                        <h3>üõ†Ô∏è SAXTech Resource Library</h3>
                        <p style="margin-bottom: 15px; color: #666;">Pre-configured SAXTech resources with standard rates. The chatbot can reference these when building your implementation plan.</p>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Resource Type</th>
                                    <th>Role/Skill Level</th>
                                    <th>Hourly Rate</th>
                                    <th>Typical Tasks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="saxTechResourcesBody">
                                <!-- Dynamic SAXTech resources will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addSAXTechResource()">+ Add SAXTech Resource</button>
                    </div>
                    
                    <div class="config-panel" style="margin-top: 20px;">
                        <h3>üìã Build Your Implementation Cost</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; margin-right: 10px;">Quick Add SAXTech Resource:</label>
                            <select id="saxTechResourceSelector" onchange="addResourceToImplementation()" style="margin-right: 10px;">
                                <option value="">Select a SAXTech resource...</option>
                                <!-- Dynamic options will be populated -->
                            </select>
                            <input type="number" id="resourceHours" placeholder="Hours" style="width: 80px; margin-right: 10px;">
                            <button class="btn-add" onclick="addSelectedResource()">Add to Project</button>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th>Hours</th>
                                    <th>Rate</th>
                                    <th>Cost</th>
                                    <th>Resource Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="implementationCostsBody">
                                <!-- Dynamic implementation costs will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addImplementationComponent()">+ Add Custom Component</button>
                    </div>
                </div>
                
                <!-- Monthly Service Calculator -->
                <div class="section">
                    <h2 class="section-title">Monthly Service Fee Calculator</h2>
                    
                    <div class="config-panel">
                        <h3>Build Your Monthly Service Fee</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Service Component</th>
                                    <th>Monthly Hours/Units</th>
                                    <th>Rate</th>
                                    <th>Monthly Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyServiceBody">
                                <!-- Dynamic monthly service costs will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addMonthlyServiceComponent()">+ Add Service Component</button>
                        
                        <div class="config-grid" style="margin-top: 20px;">
                            <div class="config-item">
                                <label>Contract Length (months):</label>
                                <input type="number" id="contractLength" value="24" onchange="updateCalculations()">
                            </div>
                            <div class="config-item">
                                <label>Infrastructure Management Markup (%):</label>
                                <input type="number" id="infrastructureMarkup" value="20" step="1" onchange="updateCalculations()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Add-ons Calculator -->
                <div class="section">
                    <h2 class="section-title">Custom Add-ons & Optional Services</h2>
                    
                    <div class="config-panel">
                        <h3>Define Your Add-on Services</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Add-on Service</th>
                                    <th>Frequency</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customAddonsBody">
                                <!-- Dynamic add-ons will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addCustomAddon()">+ Add Custom Add-on</button>
                    </div>
                </div>
                
                <!-- Annual Impact Analysis -->
                <div class="section">
                    <h2 class="section-title">3. Annual Impact Analysis</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Manual Process</th>
                                <th>Automated Process</th>
                                <th>Annual Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Instances Processed Per Month</td>
                                <td><span id="monthlyVolumeManual">20</span></td>
                                <td><span id="monthlyVolumeAuto">20</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>Annual Instance Volume</td>
                                <td><span id="annualVolumeManual">240</span></td>
                                <td><span id="annualVolumeAuto">240</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>Time Per Instance</td>
                                <td><span id="hoursPerClientManual">6.67</span> hours</td>
                                <td><span id="hoursPerClientAuto">0.45</span> hours</td>
                                <td><span id="hoursPerClientSaved">6.22</span> hours</td>
                            </tr>
                            <tr>
                                <td>Annual Time Investment</td>
                                <td><span id="annualHoursManual">1,600</span> hours</td>
                                <td><span id="annualHoursAuto">108</span> hours</td>
                                <td class="savings"><span id="annualHoursSaved">1,492</span> hours saved</td>
                            </tr>
                            <tr>
                                <td>Cost Per Instance</td>
                                <td>$<span id="costPerClientManual">593.32</span></td>
                                <td>$<span id="costPerClientAuto">49.64</span></td>
                                <td>$<span id="costPerClientSaved">543.68</span></td>
                            </tr>
                            <tr class="highlight">
                                <td><strong>Annual Labor Cost</strong></td>
                                <td><strong>$<span id="annualCostManual">142,397</span></strong></td>
                                <td><strong>$<span id="annualCostAuto">11,914</span></strong></td>
                                <td class="savings"><strong>$<span id="annualCostSaved">130,483</span> saved</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3 style="margin-top: 30px;">Additional Annual Operating Costs for Automated Solution</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Cost Component</th>
                                <th>Monthly Cost</th>
                                <th>Annual Cost</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="operatingCostsBody">
                            <!-- Dynamic operating costs will be here -->
                        </tbody>
                    </table>
                    <button class="btn-add" onclick="addOperatingCost()">+ Add Operating Cost</button>
                    
                    <div class="roi-summary" style="margin-top: 30px;">
                        <h3>Net Annual Savings</h3>
                        <div class="formula">
                            Labor Savings: $<span id="formulaLaborSavings">130,483</span><br>
                            - Operating Costs: $<span id="formulaOperatingCosts">7,500</span><br>
                            - SAXTech Monthly Service: $<span id="formulaMonthlyService">2,100</span> √ó 12 = $<span id="formulaAnnualService">25,200</span><br>
                            ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br>
                            <strong>Net Annual Savings: $<span id="netAnnualSavings">97,783</span></strong>
                        </div>
                    </div>
                </div>
                
                <!-- Project Timeline -->
                <div class="section">
                    <h2 class="section-title">4. Project Timeline & Deliverables</h2>
                    
                    <div class="config-panel">
                        <h3>üìÖ Implementation Timeline</h3>
                        <p style="margin-bottom: 15px; color: #666;">Define project phases, durations, activities, and deliverables. The chatbot can help populate these based on your requirements.</p>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th>Duration (Weeks)</th>
                                    <th>Key Activities</th>
                                    <th>Deliverables</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timelineBody">
                                <!-- Dynamic timeline phases will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addTimelinePhase()">+ Add Phase</button>
                        
                        <div class="timeline-summary" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                            <h4>Timeline Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                                <div>
                                    <strong>Total Duration:</strong> <span id="totalDuration">8</span> weeks
                                </div>
                                <div>
                                    <strong>Total Phases:</strong> <span id="totalPhases">4</span> phases
                                </div>
                                <div>
                                    <strong>Project Start:</strong> <span id="projectStart">TBD</span>
                                </div>
                                <div>
                                    <strong>Go-Live Date:</strong> <span id="goLiveDate">TBD</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SAXTech Pricing Model -->
                <div class="section">
                    <h2 class="section-title">5. SAXTech Pricing Recommendation</h2>
                    
                    <div class="pricing-options">
                        <div class="pricing-card">
                            <h3>Implementation Cost</h3>
                            <div class="price">$<span id="displayImplementationCost">37,850</span></div>
                            <div class="price-label">One-time setup fee</div>
                            <ul style="text-align: left; margin-top: 20px;">
                                <li>Complete automation workflow setup</li>
                                <li>API integrations (all systems)</li>
                                <li>AI agent configuration</li>
                                <li>Web forms & portals</li>
                                <li>Azure environment setup</li>
                                <li>Testing & validation</li>
                                <li>Staff training (8 hours)</li>
                                <li>30-day hypercare support</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card recommended">
                            <h3>Monthly Service Fee</h3>
                            <div class="price">$<span id="displayMonthlyFee">2,100</span></div>
                            <div class="price-label">Per month (<span id="displayContractLength">24</span>-month contract)</div>
                            <ul style="text-align: left; margin-top: 20px;">
                                <li>Hosting & infrastructure</li>
                                <li>AI token costs included</li>
                                <li>System monitoring 24/7</li>
                                <li>Monthly optimization</li>
                                <li>Workflow adjustments</li>
                                <li>8 support hours/month</li>
                                <li>Quarterly business reviews</li>
                                <li>99.5% uptime SLA</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card">
                            <h3>Optional Add-ons</h3>
                            <div class="price">Custom</div>
                            <div class="price-label">As needed</div>
                            <ul style="text-align: left; margin-top: 20px;" id="addonsList">
                                <!-- Dynamic add-ons will be displayed here -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Competitive Pricing Analysis -->
                <div class="section">
                    <h2 class="section-title">6. Competitive Pricing Analysis</h2>
                    
                    <div class="config-panel">
                        <h3>üí∞ Market Comparison</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Solution Provider</th>
                                    <th>Implementation</th>
                                    <th>Monthly Cost</th>
                                    <th>Annual TCO (Y1)</th>
                                    <th>Pros/Cons</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="competitiveAnalysisBody">
                                <!-- Dynamic competitive analysis will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addCompetitor()">+ Add Competitor</button>
                        
                        <div class="competitive-summary" style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 8px;">
                            <h4>üéØ Why SAXTech's Pricing is Optimal:</h4>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li><strong id="costComparison">33% of Big 4 cost</strong> with better customization</li>
                                <li>Includes advanced AI capabilities competitors lack</li>
                                <li>Fixed monthly pricing provides budget certainty</li>
                                <li>Local support with industry expertise</li>
                                <li>Proven n8n platform with enterprise reliability</li>
                                <li>Comprehensive automation beyond basic workflow tools</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Mitigation -->
                <div class="section">
                    <h2 class="section-title">7. Risk Mitigation & Success Factors</h2>
                    
                    <div class="config-panel">
                        <h3>‚ö†Ô∏è Risk Assessment & Mitigation Strategies</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Risk Factor</th>
                                    <th>Probability</th>
                                    <th>Impact</th>
                                    <th>Mitigation Strategy</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="riskMitigationBody">
                                <!-- Dynamic risk mitigation will be here -->
                            </tbody>
                        </table>
                        <button class="btn-add" onclick="addRiskFactor()">+ Add Risk Factor</button>
                        
                        <div class="success-factors" style="margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 8px;">
                            <h4>‚úÖ Critical Success Factors:</h4>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li><strong>Executive Sponsorship:</strong> Clear leadership commitment and communication</li>
                                <li><strong>Change Management:</strong> Comprehensive training and phased user adoption</li>
                                <li><strong>Technical Excellence:</strong> Thorough testing, monitoring, and quality assurance</li>
                                <li><strong>Ongoing Support:</strong> Regular optimization and responsive technical support</li>
                                <li><strong>Clear Metrics:</strong> Defined KPIs and regular progress measurement</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ROI Calculation -->
                <div class="section">
                    <h2 class="section-title">8. Return on Investment Analysis</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>ROI Component</th>
                                <th>Year 1</th>
                                <th>Year 2</th>
                                <th>3-Year Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Investment</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Implementation Cost</td>
                                <td class="cost">($<span id="roiImplementationY1">37,850</span>)</td>
                                <td>$0</td>
                                <td>($<span id="roiImplementation3Y">37,850</span>)</td>
                            </tr>
                            <tr>
                                <td>Monthly Service Fee</td>
                                <td class="cost">($<span id="roiServiceY1">25,200</span>)</td>
                                <td class="cost">($<span id="roiServiceY2">25,200</span>)</td>
                                <td>($<span id="roiService3Y">75,600</span>)</td>
                            </tr>
                            <tr>
                                <td>Operating Costs</td>
                                <td class="cost">($<span id="roiOperatingY1">7,500</span>)</td>
                                <td class="cost">($<span id="roiOperatingY2">7,500</span>)</td>
                                <td>($<span id="roiOperating3Y">22,500</span>)</td>
                            </tr>
                            <tr class="highlight">
                                <td><strong>Total Investment</strong></td>
                                <td class="cost"><strong>($<span id="roiTotalInvestY1">70,550</span>)</strong></td>
                                <td class="cost"><strong>($<span id="roiTotalInvestY2">32,700</span>)</strong></td>
                                <td><strong>($<span id="roiTotalInvest3Y">135,950</span>)</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Benefits</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Labor Cost Savings</td>
                                <td class="savings">$<span id="roiLaborY1">130,483</span></td>
                                <td class="savings">$<span id="roiLaborY2">130,483</span></td>
                                <td>$<span id="roiLabor3Y">391,449</span></td>
                            </tr>
                            <tr>
                                <td>Error Reduction (est. 2%)</td>
                                <td class="savings">$<span id="roiErrorY1">15,000</span></td>
                                <td class="savings">$<span id="roiErrorY2">15,000</span></td>
                                <td>$<span id="roiError3Y">45,000</span></td>
                            </tr>
                            <tr>
                                <td>Faster Time-to-Revenue</td>
                                <td class="savings">$<span id="roiRevenueY1">20,000</span></td>
                                <td class="savings">$<span id="roiRevenueY2">20,000</span></td>
                                <td>$<span id="roiRevenue3Y">60,000</span></td>
                            </tr>
                            <tr class="highlight">
                                <td><strong>Total Benefits</strong></td>
                                <td class="savings"><strong>$<span id="roiTotalBenefitsY1">165,483</span></strong></td>
                                <td class="savings"><strong>$<span id="roiTotalBenefitsY2">165,483</span></strong></td>
                                <td><strong>$<span id="roiTotalBenefits3Y">496,449</span></strong></td>
                            </tr>
                            <tr style="background: #d4edda;">
                                <td><strong>Net Benefit</strong></td>
                                <td><strong>$<span id="roiNetY1">94,933</span></strong></td>
                                <td><strong>$<span id="roiNetY2">132,783</span></strong></td>
                                <td><strong>$<span id="roiNet3Y">360,499</span></strong></td>
                            </tr>
                            <tr style="background: #d4edda;">
                                <td><strong>ROI %</strong></td>
                                <td><strong><span id="roiPercentY1">135</span>%</strong></td>
                                <td><strong><span id="roiPercentY2">406</span>%</strong></td>
                                <td><strong><span id="roiPercent3Y">265</span>%</strong></td>
                            </tr>
                            <tr style="background: #d4edda;">
                                <td><strong>Payback Period</strong></td>
                                <td><strong><span id="paybackMonths">2.8</span> months</strong></td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="note">
                        <strong>Additional Qualitative Benefits:</strong>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Customer Experience:</strong> Faster processing times, digital interactions, real-time status updates</li>
                            <li><strong>Data Quality:</strong> AI validation reduces errors and ensures data completeness and accuracy</li>
                            <li><strong>Compliance & Risk:</strong> Automated validation checks and consistent risk assessment procedures</li>
                            <li><strong>Scalability:</strong> Can handle 10x current volume without proportional staff increases</li>
                            <li><strong>Senior Staff Time:</strong> Frees up <span id="partnerHoursFreed">240</span> hours/year of senior staff time for high-value activities</li>
                            <li><strong>Staff Satisfaction:</strong> Eliminates repetitive manual tasks and reduces human error stress</li>
                            <li><strong>Audit Trail:</strong> Complete digital documentation and process transparency</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Executive Recommendation -->
                <div class="roi-summary">
                    <h2>Executive Recommendation</h2>
                    <p style="font-size: 1.2em; line-height: 1.6;">
                        Based on the comprehensive ROI analysis, SAXTech recommends immediate implementation of the automation solution for <span id="execClientName">Your Company</span>'s <span id="execProcessName">process name</span> process.
                    </p>
                    <br>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Investment Summary:</h3>
                            <ul style="list-style: none; padding: 0; font-weight: 600;">
                                <li>‚úì Total Year 1 Investment: $<span id="execY1Investment">70,550</span></li>
                                <li>‚úì Net Year 1 Savings: $<span id="execY1Savings">94,933</span></li>
                                <li>‚úì Payback Period: <span id="execPayback">2.8</span> months</li>
                                <li>‚úì 3-Year ROI: <span id="exec3YearROI">265</span>%</li>
                            </ul>
                        </div>
                        <div>
                            <h3 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Strategic Benefits:</h3>
                            <ul style="list-style: none; padding: 0; font-weight: 600;">
                                <li>‚úì <span id="execTimeReduction">91.7</span>% reduction in processing time</li>
                                <li>‚úì Frees <span id="execPartnerHours">240</span> partner hours annually</li>
                                <li>‚úì AI-powered risk management</li>
                                <li>‚úì Scalable for growth</li>
                            </ul>
                        </div>
                    </div>
                    <br>
                    <p style="font-size: 1.1em; font-weight: 600;">
                        <strong>Next Steps:</strong> Sign <span id="execContractLength">24</span>-month service agreement and begin 8-week implementation immediately to capture Q2 2025 benefits.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-header">
                <h3>ü§ñ ROI Assistant</h3>
                <p>I'll help you build your automation ROI analysis by asking the right questions</p>
            </div>
            
            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-content">üëã Welcome! I'm your ROI Assistant. I'll help you analyze your automation project by asking targeted questions about your current process, costs, and automation goals.</div>
                </div>
            </div>
            
            <div class="typing-indicator message" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="quick-actions" id="quickActions">
                    <div class="quick-action" onclick="sendQuickMessage('Start ROI analysis')">üöÄ Start Analysis</div>
                    <div class="quick-action" onclick="sendQuickMessage('Help me define roles')">üë• Define Roles</div>
                    <div class="quick-action" onclick="sendQuickMessage('Map current process')">üìã Map Process</div>
                    <div class="quick-action" onclick="sendQuickMessage('Calculate costs')">üí∞ Calculate Costs</div>
                </div>
                <div class="input-group">
                    <textarea id="chatInput" placeholder="Describe your process or ask me anything about ROI calculations..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize global variables with empty defaults
        let roles = [
            { title: "Partner/Requester", salary: 150000, burdened: 202500, hourly: 97.36 },
            { title: "Manager", salary: 80000, burdened: 108000, hourly: 51.92 },
            { title: "Staff", salary: 50000, burdened: 67500, hourly: 32.45 },
            { title: "Admin", salary: 35000, burdened: 47250, hourly: 22.72 }
        ];
        
        let manualSteps = [];
        let automatedSteps = [];
        
        let operatingCosts = [
            { name: "SAXTech Automation Engine", monthly: 15, notes: "Usage Fee" },
            { name: "Bandwidth", monthly: 5, notes: "Internet Usage" },
            { name: "Backups", monthly: 5, notes: "Workflow and Site config backups" },
            { name: "Website Artifact Hosting", monthly: 50, notes: "Three website front-ends" }
        ];
        
        // SAXTech Resource Library - predefined resources with rates and capabilities
        let saxTechResources = [
            { 
                type: "Senior Solution Architect", 
                role: "Principal", 
                rate: 225, 
                tasks: "Solution design, technical leadership, client workshops",
                expertise: "Enterprise architecture, AI strategy, complex integrations"
            },
            { 
                type: "Solution Architect", 
                role: "Senior", 
                rate: 175, 
                tasks: "Technical analysis, solution design, architecture documentation",
                expertise: "Business analysis, workflow design, system integration"
            },
            { 
                type: "Senior Developer", 
                role: "Senior", 
                rate: 150, 
                tasks: "Core development, API integrations, automation workflows",
                expertise: "Full-stack development, Azure, automation platforms"
            },
            { 
                type: "AI Specialist", 
                role: "Senior", 
                rate: 175, 
                tasks: "AI agent configuration, prompt engineering, model optimization",
                expertise: "OpenAI, Azure AI, natural language processing"
            },
            { 
                type: "DevOps Engineer", 
                role: "Mid", 
                rate: 140, 
                tasks: "Azure setup, CI/CD, monitoring, deployment automation",
                expertise: "Azure cloud, Kubernetes, infrastructure as code"
            },
            { 
                type: "QA Engineer", 
                role: "Mid", 
                rate: 125, 
                tasks: "Testing, quality assurance, user acceptance testing",
                expertise: "Automated testing, manual testing, test planning"
            },
            { 
                type: "Technical Writer", 
                role: "Mid", 
                rate: 125, 
                tasks: "Documentation, user guides, training materials",
                expertise: "Technical documentation, user experience, training design"
            },
            { 
                type: "Project Manager", 
                role: "Senior", 
                rate: 165, 
                tasks: "Project coordination, stakeholder management, delivery oversight",
                expertise: "Agile methodology, client communication, risk management"
            },
            { 
                type: "Junior Developer", 
                role: "Junior", 
                rate: 95, 
                tasks: "Support development, testing assistance, documentation",
                expertise: "Basic development, testing, documentation support"
            },
            { 
                type: "UI/UX Designer", 
                role: "Mid", 
                rate: 135, 
                tasks: "User interface design, user experience optimization",
                expertise: "Web design, user research, prototyping"
            }
        ];
        
        let implementationComponents = [
            { name: "Discovery & Business Analysis", hours: 40, rate: 175, resourceType: "Solution Architect" },
            { name: "Solution Architecture & Design", hours: 60, rate: 175, resourceType: "Solution Architect" },
            { name: "Core Automation Development", hours: 80, rate: 150, resourceType: "Senior Developer" },
            { name: "API Integration Development", hours: 60, rate: 150, resourceType: "Senior Developer" },
            { name: "AI Agent Configuration", hours: 30, rate: 175, resourceType: "AI Specialist" },
            { name: "Web Forms & Portal Development", hours: 40, rate: 150, resourceType: "Senior Developer" },
            { name: "Azure Environment Setup", hours: 25, rate: 140, resourceType: "DevOps Engineer" },
            { name: "Testing & Quality Assurance", hours: 40, rate: 125, resourceType: "QA Engineer" },
            { name: "User Training & Documentation", hours: 20, rate: 125, resourceType: "Technical Writer" },
            { name: "Deployment & Go-Live Support", hours: 15, rate: 150, resourceType: "Senior Developer" }
        ];
        
        let monthlyServiceComponents = [
            { name: "Infrastructure Hosting", hours: 0, rate: 0, fixedCost: 750 },
            { name: "System Monitoring & Maintenance", hours: 8, rate: 125 },
            { name: "Monthly Performance Optimization", hours: 6, rate: 150 },
            { name: "Technical Support (8hrs/month)", hours: 8, rate: 125 },
            { name: "Workflow Updates & Enhancements", hours: 4, rate: 150 }
        ];
        
        let customAddons = [
            { name: "Additional Integration", frequency: "one-time", amount: 2500, unit: "per API integration" },
            { name: "Custom Reporting Dashboard", frequency: "one-time", amount: 5000, unit: "complete dashboard" },
            { name: "Extra Support Hours", frequency: "monthly", amount: 125, unit: "per additional hour" },
            { name: "Advanced AI Features", frequency: "monthly", amount: 500, unit: "AI add-on package" },
            { name: "White-label Portal", frequency: "one-time", amount: 3000, unit: "portal customization" }
        ];
        
        // Project Timeline data
        let timelinePhases = [
            {
                phase: "Discovery & Planning",
                duration: 2,
                activities: "Requirements gathering, stakeholder interviews, current state analysis, solution design",
                deliverables: "Requirements document, technical architecture, project plan, SOW approval"
            },
            {
                phase: "Development & Configuration",
                duration: 4,
                activities: "Core automation development, API integrations, AI agent setup, user interface creation",
                deliverables: "Functional automation workflows, integrated systems, AI agents, web portals"
            },
            {
                phase: "Testing & Training",
                duration: 1.5,
                activities: "System testing, user acceptance testing, staff training, documentation creation",
                deliverables: "Tested system, trained users, user guides, technical documentation"
            },
            {
                phase: "Deployment & Go-Live",
                duration: 0.5,
                activities: "Production deployment, go-live support, monitoring setup, hypercare period start",
                deliverables: "Live production system, monitoring dashboards, support procedures"
            }
        ];
        
        // Competitive Analysis data
        let competitiveAnalysis = [
            {
                provider: "SAXTech (Proposed)",
                implementation: 0, // Will be calculated dynamically
                monthly: 0, // Will be calculated dynamically
                annual: 0, // Will be calculated dynamically
                proscons: "‚úì Custom fit\n‚úì AI-powered\n‚úì Full support\n‚úì Fixed pricing",
                isSAXTech: true
            },
            {
                provider: "Big 4 Consulting",
                implementation: 150000,
                monthly: 5000,
                annual: 210000,
                proscons: "‚úó Expensive\n‚úó Generic solution\n‚úó Long timelines\n‚úó Limited AI",
                isSAXTech: false
            },
            {
                provider: "Offshore Development",
                implementation: 15000,
                monthly: 500,
                annual: 21000,
                proscons: "‚úó Quality risks\n‚úó No AI integration\n‚úó Communication barriers\n‚úó Limited support",
                isSAXTech: false
            },
            {
                provider: "In-House Development",
                implementation: 75000,
                monthly: 3500,
                annual: 117000,
                proscons: "‚úó Resource intensive\n‚úó Ongoing maintenance\n‚úó Limited expertise\n‚úó Opportunity cost",
                isSAXTech: false
            },
            {
                provider: "SaaS Platform",
                implementation: 5000,
                monthly: 3000,
                annual: 41000,
                proscons: "‚úó Limited customization\n‚úó No AI features\n‚úó Generic workflows\n‚úó Data limitations",
                isSAXTech: false
            }
        ];
        
        // Risk Mitigation data
        let riskFactors = [
            {
                risk: "API Changes",
                probability: "Low",
                impact: "Medium",
                mitigation: "Monthly monitoring, version control, rapid response team, fallback procedures"
            },
            {
                risk: "User Adoption",
                probability: "Medium",
                impact: "High",
                mitigation: "Comprehensive training, change management, phased rollout, ongoing support"
            },
            {
                risk: "System Downtime",
                probability: "Low",
                impact: "High",
                mitigation: "99.5% SLA, redundancy, manual fallback procedures, 24/7 monitoring"
            },
            {
                risk: "Data Security",
                probability: "Low",
                impact: "Critical",
                mitigation: "Azure security, encryption, regular audits, compliance frameworks"
            },
            {
                risk: "Integration Issues",
                probability: "Medium",
                impact: "Medium",
                mitigation: "Thorough testing, sandbox environment, rollback plans, expert support"
            }
        ];
        
        let selectedAIModel = 'gpt4-mini';
        let chatHistory = [];
        let isWebhookConnected = false;
        
        // Sample company data (GreerWalker) - Updated with new JSON structure
        const sampleCompanyData = {
            clientName: "Greer Walker",
            processName: "Client Onboarding",
            monthlyVolume: 20,
            burdenPercent: 25,
            contractLength: 24,
            roles: [
                { title: "Partner/Requester", salary: 300000, burdened: 375000, hourly: 180.29 },
                { title: "Manager", salary: 120000, burdened: 150000, hourly: 72.12 },
                { title: "Marketing Admin", salary: 75000, burdened: 93750, hourly: 45.07 },
                { title: "Admin", salary: 50000, burdened: 62500, hourly: 30.05 }
            ],
            manualSteps: [
                { step: "1. Opportunity Received", role: 1, time: 5 },
                { step: "2. Determine Proposal Type", role: 1, time: 5 },
                { step: "3. Fill Proposal Request Form", role: 0, time: 15 },
                { step: "4. BenchmarkOne Setup", role: 2, time: 10 },
                { step: "5. Conflict/Background Checks", role: 2, time: 30 },
                { step: "6. Fill New Client Form", role: 0, time: 45 },
                { step: "7. Route to Natasia", role: 3, time: 5 },
                { step: "8. Natasia Review", role: 1, time: 20 },
                { step: "9. STAR Data Entry", role: 1, time: 45 },
                { step: "10. Engagement Setup", role: 1, time: 20 },
                { step: "11. XCM Task Creation", role: 1, time: 20 },
                { step: "12. Network Folders Setup", role: 1, time: 10 },
                { step: "13. Route to Baylee", role: 1, time: 5 },
                { step: "14. Email Client Biller", role: 2, time: 5 },
                { step: "15. Client Biller Forwards", role: 3, time: 5 },
                { step: "16. Process Consent Return", role: 2, time: 15 },
                { step: "17. Update BD/Mailing Data", role: 2, time: 10 },
                { step: "18. Update BenchmarkOne", role: 2, time: 10 },
                { step: "19. File in Perm Binder", role: 2, time: 15 },
                { step: "20. Follow-up Lost Proposals", role: 2, time: 20 }
            ],
            automatedSteps: [
                { step: "Web Form Submission", role: 0, time: 15, feature: "Simplified web form", isAI: false },
                { step: "AI Form Validation", role: -1, time: 0, feature: "GPT-4 validation", isAI: true },
                { step: "Automatic BenchmarkOne", role: -1, time: 0, feature: "API Integration", isAI: false },
                { step: "AI Risk Assessment", role: -1, time: 0, feature: "GPT-4 analysis", isAI: true },
                { step: "Manager Quick Review", role: 1, time: 10, feature: "AI pre-screened", isAI: false },
                { step: "Auto STAR Creation", role: -1, time: 0, feature: "API Integration", isAI: false },
                { step: "Auto Engagement Setup", role: -1, time: 0, feature: "API Integration", isAI: false },
                { step: "Auto XCM Tasks", role: -1, time: 0, feature: "API Integration", isAI: false },
                { step: "Auto Network Folders", role: -1, time: 0, feature: "Azure Files API", isAI: false },
                { step: "Auto Email Notifications", role: -1, time: 0, feature: "Email automation", isAI: false },
                { step: "Digital Consent Process", role: 3, time: 2, feature: "Web portal", isAI: false },
                { step: "Auto BD/Mailing Update", role: -1, time: 0, feature: "API Integration", isAI: false },
                { step: "Auto Filing", role: -1, time: 0, feature: "Document automation", isAI: false },
                { step: "Weekly Proposal Check", role: 2, time: 15, feature: "Scheduled automation", isAI: false }
            ],
            operatingCosts: [
                { name: "SAXTech Automation Engine", monthly: 15, notes: "Usage Fee" },
                { name: "Bandwidth", monthly: 5, notes: "Internet Usage" },
                { name: "Backups", monthly: 5, notes: "Workflow and Site config backups" },
                { name: "Website Artifact Hosting", monthly: 50, notes: "Three website front-ends" }
            ],
            implementationComponents: [
                { name: "Discovery & Business Analysis", hours: 8, rate: 175, resourceType: "Solution Architect" },
                { name: "Solution Architecture & Design", hours: 16, rate: 175, resourceType: "Solution Architect" },
                { name: "Core Automation Development", hours: 16, rate: 150, resourceType: "Senior Developer" },
                { name: "API Integration Development", hours: 16, rate: 150, resourceType: "Senior Developer" },
                { name: "AI Agent Configuration", hours: 4, rate: 175, resourceType: "AI Specialist" },
                { name: "Web Forms & Portal Development", hours: 12, rate: 150, resourceType: "Senior Developer" },
                { name: "Azure Environment Setup", hours: 2, rate: 140, resourceType: "DevOps Engineer" },
                { name: "Testing & Quality Assurance", hours: 12, rate: 125, resourceType: "QA Engineer" },
                { name: "User Training & Documentation", hours: 4, rate: 125, resourceType: "Technical Writer" },
                { name: "Deployment & Go-Live Support", hours: 16, rate: 225, resourceType: "Senior Solution Architect" }
            ],
            monthlyServiceComponents: [
                { name: "System Monitoring & Maintenance", hours: 1, rate: 125, fixedCost: null },
                { name: "Monthly Performance Optimization", hours: 1.5, rate: 150, fixedCost: null },
                { name: "Technical Support (8hrs/month)", hours: 8, rate: 125 },
                { name: "Workflow Updates & Enhancements", hours: 7, rate: 150, fixedCost: null }
            ],
            customAddons: [
                { name: "Additional Integration", frequency: "one-time", amount: 2500, unit: "per API integration" }
            ],
            selectedAIModel: "gpt41-mini",
            inputTokens: "3000",
            outputTokens: "3000",
            aiCalls: "8"
        };
        
        const aiPricing = {
            'gpt4-mini': { input: 0.00015, output: 0.0006 },
            'gpt41-mini': { input: 0.0003, output: 0.0012 },
            'gpt5': { input: 0.025, output: 0.075 }
        };
        
        // Chat Interface Functions
        function initializeChat() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Hard-coded webhook URL
            const webhookUrl = 'https://workflows.saxtechnology.com/webhook/roi-assistant';
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                
                // Enable/disable send button
                sendBtn.disabled = !this.value.trim();
            });
            
            // Send on Enter (but not Shift+Enter)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });
            
            // Test webhook connection on initialization
            setTimeout(testWebhookConnection, 1000);
            
            // Send initial greeting
            setTimeout(() => {
                addMessage('assistant', "Hello! I'm your ROI Assistant. I can help you analyze your automation project by asking targeted questions. What type of business process are you looking to automate?");
            }, 2000);
        }
        
        function addMessage(sender, content, showTyping = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in chat history
            chatHistory.push({ role: sender === 'user' ? 'user' : 'assistant', content: content });
        }
        
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }
        
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;
            
            // Process message
            processUserMessage(message);
        }
        
        function sendQuickMessage(message) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = message;
            chatInput.style.height = 'auto';
            document.getElementById('sendBtn').disabled = false;
            sendMessage();
        }
        
        async function processUserMessage(message) {
            showTypingIndicator();
            
            // Hard-coded webhook URL
            const webhookUrl = 'https://workflows.saxtechnology.com/webhook/roi-assistant';
            
            if (isWebhookConnected) {
                await processWithWebhook(message, webhookUrl);
            } else {
                await processLocally(message);
            }
            
            hideTypingIndicator();
        }
        
        async function processWithWebhook(message, webhookUrl) {
            try {
                const currentState = getCurrentROIState();
                
                const payload = {
                    action: 'chat_message',
                    message: message,
                    chatHistory: chatHistory,
                    currentState: currentState,
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Handle response
                if (data.message) {
                    addMessage('assistant', data.message);
                }
                
                // Apply any field updates
                if (data.updates) {
                    applyROIUpdates(data.updates);
                }
                
                // Show suggested actions
                if (data.suggestions) {
                    updateQuickActions(data.suggestions);
                }
                
                // Handle PDF generation
                if (data.generatePDF) {
                    await generateAndDownloadPDF(data.generatePDF);
                }
                
            } catch (error) {
                console.error('Webhook error:', error);
                addMessage('assistant', "I'm having trouble connecting to my analysis engine. Let me help you locally for now. " + await getLocalResponse(message));
            }
        }
        
        async function processLocally(message) {
            // Simple local processing logic
            const response = await getLocalResponse(message);
            addMessage('assistant', response);
        }
        
        async function getLocalResponse(message) {
            const msg = message.toLowerCase();
            
            // Pattern matching for common queries
            if (msg.includes('start') || msg.includes('begin') || msg.includes('help')) {
                return "Great! Let's start building your ROI analysis. First, what's the name of your company and what specific business process are you looking to automate? For example: 'client onboarding', 'invoice processing', 'employee hiring', etc.";
            }
            
            if (msg.includes('role') || msg.includes('salary') || msg.includes('cost')) {
                return "I can help you define the roles involved in your process. What are the main job titles/roles that currently handle this process? Please also include their approximate annual salaries if you know them. For example: 'Partner - $300k, Manager - $150k, Staff - $90k'";
            }
            
            if (msg.includes('process') || msg.includes('step') || msg.includes('workflow')) {
                return "Let me help you map out your current process. Can you walk me through the main steps in your current manual process? Start with step 1 and tell me who does it and roughly how long it takes. For example: '1. Partner reviews new client inquiry (10 minutes)'";
            }
            
            if (msg.includes('implementation') || msg.includes('resource') || msg.includes('team') || msg.includes('who will')) {
                const resourceList = saxTechResources.map(r => `${r.type} ($${r.rate}/hr)`).join(', ');
                return `I can help you plan the implementation team and costs. SAXTech has these resources available: ${resourceList}. What type of complexity do you expect for your automation project? This will help me recommend the right mix of resources and estimate hours.`;
            }
            
            if (msg.includes('timeline') || msg.includes('schedule') || msg.includes('duration') || msg.includes('when')) {
                const totalWeeks = timelinePhases.reduce((sum, phase) => sum + phase.duration, 0);
                return `I can help you plan the project timeline. Currently, the estimated timeline is ${totalWeeks} weeks across ${timelinePhases.length} phases. What are your target dates or any specific timeline constraints for this project?`;
            }
            
            if (msg.includes('competitor') || msg.includes('pricing') || msg.includes('compare') || msg.includes('alternative')) {
                return `I can help you understand how SAXTech compares to other solutions. We've analyzed several alternatives including Big 4 consulting, offshore development, in-house development, and SaaS platforms. What specific aspects would you like me to compare - pricing, capabilities, timeline, or support?`;
            }
            
            if (msg.includes('pdf') || msg.includes('generate') || msg.includes('download') || msg.includes('document')) {
                // Generate professional SAXTech SOW PDF
                setTimeout(() => {
                    const currentState = getCurrentROIState();
                    const pdfData = generatePDFData(currentState);
                    generateAndDownloadPDF(pdfData);
                }, 500);
                return "I'll generate a comprehensive Statement of Work PDF using the professional SAXTech template. This will include all your ROI calculations, implementation plan, investment summary, and executive recommendations.";
            }
            
            if (msg.includes('cost') || msg.includes('calculate') || msg.includes('money')) {
                return "I'll help you calculate the costs. Based on what you've told me so far, I can see some patterns. What's your typical monthly volume for this process? How many times per month do you complete this workflow?";
            }
            
            if (msg.includes('automation') || msg.includes('ai') || msg.includes('technology')) {
                return "Excellent! For automation planning, I need to understand what parts of your process can be automated. Which steps do you think could be handled by AI, API integrations, or other automation tools? Also, which steps will still need human oversight?";
            }
            
            // Try to extract company/process names
            const companyMatch = msg.match(/company(?:\s+is)?[:\s]+([a-zA-Z\s]+)/i);
            const processMatch = msg.match(/process(?:\s+is)?[:\s]+([a-zA-Z\s]+)/i);
            
            if (companyMatch) {
                const company = companyMatch[1].trim();
                document.getElementById('inputClientName').value = company;
                updateCalculations();
                return `Great! I've set the company name to "${company}". Now, what specific business process are you looking to automate?`;
            }
            
            if (processMatch) {
                const process = processMatch[1].trim();
                document.getElementById('inputProcessName').value = process;
                updateCalculations();
                return `Perfect! I've set the process to "${process}". Now let's define the roles involved. What job titles/roles currently handle this process and what are their approximate salaries?`;
            }
            
            // Default response
            return "I understand you're working on " + message + ". Can you provide more specific details? I can help you with defining roles, mapping process steps, calculating costs, or planning automation strategies. What would you like to focus on first?";
        }
        
        function getCurrentROIState() {
            return {
                clientName: document.getElementById('inputClientName').value,
                processName: document.getElementById('inputProcessName').value,
                monthlyVolume: parseFloat(document.getElementById('monthlyVolume').value) || 0,
                burdenPercent: parseFloat(document.getElementById('burdenPercent').value) || 35,
                roles: roles,
                manualSteps: manualSteps,
                automatedSteps: automatedSteps,
                selectedAIModel: selectedAIModel,
                operatingCosts: operatingCosts,
                saxTechResources: saxTechResources,
                implementationComponents: implementationComponents,
                monthlyServiceComponents: monthlyServiceComponents,
                customAddons: customAddons,
                timelinePhases: timelinePhases,
                competitiveAnalysis: competitiveAnalysis,
                riskFactors: riskFactors
            };
        }
        
        function applyROIUpdates(updates) {
            try {
                if (updates.clientName) {
                    document.getElementById('inputClientName').value = updates.clientName;
                }
                if (updates.processName) {
                    document.getElementById('inputProcessName').value = updates.processName;
                }
                if (updates.monthlyVolume) {
                    document.getElementById('monthlyVolume').value = updates.monthlyVolume;
                }
                if (updates.roles) {
                    roles = updates.roles;
                }
                if (updates.manualSteps) {
                    manualSteps = updates.manualSteps;
                }
                if (updates.automatedSteps) {
                    automatedSteps = updates.automatedSteps;
                }
                
                // Re-render and recalculate
                renderAll();
                updateCalculations();
                
                addMessage('system', 'I\'ve updated your ROI analysis with the new information!');
                
            } catch (error) {
                console.error('Error applying updates:', error);
                addMessage('assistant', 'I had trouble updating some fields. Please double-check the data.');
            }
        }
        
        function updateQuickActions(suggestions) {
            const quickActions = document.getElementById('quickActions');
            quickActions.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const actionDiv = document.createElement('div');
                actionDiv.className = 'quick-action';
                actionDiv.textContent = suggestion;
                actionDiv.onclick = () => sendQuickMessage(suggestion);
                quickActions.appendChild(actionDiv);
            });
        }
        
        async function testWebhookConnection() {
            // Hard-coded webhook URL
            const webhookUrl = 'https://workflows.saxtechnology.com/webhook/roi-assistant';
            
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test_connection',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    isWebhookConnected = true;
                    console.log('‚úì Connected to n8n webhook');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.log('‚úó Webhook connection failed:', error.message);
                isWebhookConnected = false;
            }
        }
        
        // Load sample company data
        function loadSampleCompany() {
            console.log('Loading sample company data...');
            if (confirm('This will load the GreerWalker sample company data. Continue?')) {
                // Update form values
                document.getElementById('inputClientName').value = sampleCompanyData.clientName;
                document.getElementById('inputProcessName').value = sampleCompanyData.processName;
                document.getElementById('monthlyVolume').value = sampleCompanyData.monthlyVolume;
                document.getElementById('burdenPercent').value = sampleCompanyData.burdenPercent;
                document.getElementById('contractLength').value = sampleCompanyData.contractLength;
                
                // Load sample data
                roles = JSON.parse(JSON.stringify(sampleCompanyData.roles)); // Deep copy
                manualSteps = JSON.parse(JSON.stringify(sampleCompanyData.manualSteps)); // Deep copy
                automatedSteps = JSON.parse(JSON.stringify(sampleCompanyData.automatedSteps)); // Deep copy
                operatingCosts = JSON.parse(JSON.stringify(sampleCompanyData.operatingCosts)); // Deep copy
                implementationComponents = JSON.parse(JSON.stringify(sampleCompanyData.implementationComponents)); // Deep copy
                monthlyServiceComponents = JSON.parse(JSON.stringify(sampleCompanyData.monthlyServiceComponents)); // Deep copy
                customAddons = JSON.parse(JSON.stringify(sampleCompanyData.customAddons)); // Deep copy
                
                // Load AI settings
                if (sampleCompanyData.selectedAIModel) {
                    selectedAIModel = sampleCompanyData.selectedAIModel;
                    document.querySelectorAll('.ai-model-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    document.querySelector(`[onclick*="${selectedAIModel}"]`)?.classList.add('selected');
                }
                if (sampleCompanyData.inputTokens) document.getElementById('inputTokens').value = sampleCompanyData.inputTokens;
                if (sampleCompanyData.outputTokens) document.getElementById('outputTokens').value = sampleCompanyData.outputTokens;
                if (sampleCompanyData.aiCalls) document.getElementById('aiCalls').value = sampleCompanyData.aiCalls;
                
                console.log('Sample data loaded:', { roles, manualSteps, automatedSteps, operatingCosts, implementationComponents });
                
                // Re-render everything
                renderAll();
                updateCalculations();
                
                // Add chat message
                addMessage('system', 'Greer Walker sample data loaded! This shows a complete client onboarding automation analysis.');
                
                alert('Greer Walker sample company data loaded successfully!');
            }
        }
        
        // Upload logo function
        function uploadLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoImg').src = e.target.result;
                    document.getElementById('logoImg').style.display = 'block';
                    document.getElementById('logoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Print to PDF function
        function printToPDF() {
            window.print();
        }
        
        // Reset to defaults function - clears all process data but keeps pre-populated components
        function resetToDefaults() {
            if (confirm('This will reset all data to defaults (clear all process steps). Continue?')) {
                // Reset form values to defaults
                document.getElementById('inputClientName').value = 'Your Company';
                document.getElementById('inputProcessName').value = 'Process Name';
                document.getElementById('monthlyVolume').value = '10';
                document.getElementById('burdenPercent').value = '35';
                document.getElementById('contractLength').value = '24';
                document.getElementById('inputTokens').value = '3000';
                document.getElementById('outputTokens').value = '1500';
                document.getElementById('aiCalls').value = '3';
                document.getElementById('docPages').value = '3';
                document.getElementById('complexity').value = 'medium';
                
                // Reset to default empty roles
                roles = [
                    { title: "Partner/Requester", salary: 150000, burdened: 202500, hourly: 97.36 },
                    { title: "Manager", salary: 80000, burdened: 108000, hourly: 51.92 },
                    { title: "Staff", salary: 50000, burdened: 67500, hourly: 32.45 },
                    { title: "Admin", salary: 35000, burdened: 47250, hourly: 22.72 }
                ];
                
                // Clear process steps
                manualSteps = [];
                automatedSteps = [];
                
                // Reset AI model selection
                selectedAIModel = 'gpt4-mini';
                document.querySelectorAll('.ai-model-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.querySelector('.ai-model-option').classList.add('selected');
                
                // Re-render everything
                renderAll();
                updateCalculations();
                
                // Clear chat history
                chatHistory = [];
                document.getElementById('chatMessages').innerHTML = `
                    <div class="message system">
                        <div class="message-content">üëã Welcome! I'm your ROI Assistant. I'll help you analyze your automation project by asking targeted questions about your current process, costs, and automation goals.</div>
                    </div>
                `;
                
                alert('Reset to defaults completed!');
            }
        }
        
        // Save configuration function
        function saveConfiguration() {
            const config = {
                clientName: document.getElementById('inputClientName').value,
                processName: document.getElementById('inputProcessName').value,
                monthlyVolume: document.getElementById('monthlyVolume').value,
                burdenPercent: document.getElementById('burdenPercent').value,
                contractLength: document.getElementById('contractLength').value,
                roles: roles,
                manualSteps: manualSteps,
                automatedSteps: automatedSteps,
                operatingCosts: operatingCosts,
                implementationComponents: implementationComponents,
                monthlyServiceComponents: monthlyServiceComponents,
                customAddons: customAddons,
                selectedAIModel: selectedAIModel,
                inputTokens: document.getElementById('inputTokens').value,
                outputTokens: document.getElementById('outputTokens').value,
                aiCalls: document.getElementById('aiCalls').value,
                chatHistory: chatHistory
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${config.clientName}_${config.processName}_ROI_Config.json`.replace(/\s+/g, '_');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Load configuration function
        function loadConfiguration(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        // Restore form values
                        if (config.clientName) document.getElementById('inputClientName').value = config.clientName;
                        if (config.processName) document.getElementById('inputProcessName').value = config.processName;
                        if (config.monthlyVolume) document.getElementById('monthlyVolume').value = config.monthlyVolume;
                        if (config.burdenPercent) document.getElementById('burdenPercent').value = config.burdenPercent;
                        if (config.contractLength) document.getElementById('contractLength').value = config.contractLength;
                        
                        // Restore data arrays
                        if (config.roles) roles = config.roles;
                        if (config.manualSteps) manualSteps = config.manualSteps;
                        if (config.automatedSteps) automatedSteps = config.automatedSteps;
                        if (config.operatingCosts) operatingCosts = config.operatingCosts;
                        if (config.implementationComponents) implementationComponents = config.implementationComponents;
                        if (config.monthlyServiceComponents) monthlyServiceComponents = config.monthlyServiceComponents;
                        if (config.customAddons) customAddons = config.customAddons;
                        if (config.selectedAIModel) selectedAIModel = config.selectedAIModel;
                        if (config.chatHistory) chatHistory = config.chatHistory;
                        
                        // Restore AI settings
                        if (config.inputTokens) document.getElementById('inputTokens').value = config.inputTokens;
                        if (config.outputTokens) document.getElementById('outputTokens').value = config.outputTokens;
                        if (config.aiCalls) document.getElementById('aiCalls').value = config.aiCalls;
                        
                        // Restore chat history
                        if (config.chatHistory) {
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.innerHTML = '';
                            config.chatHistory.forEach(msg => {
                                addMessage(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                            });
                        }
                        
                        // Re-render everything
                        renderAll();
                        updateCalculations();
                        
                        alert('Configuration loaded successfully!');
                    } catch (error) {
                        alert('Error loading configuration file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Role management functions
        function renderRoleTable() {
            const tbody = document.getElementById('roleTableBody');
            tbody.innerHTML = '';
            
            roles.forEach((role, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${role.title}" class="role-title" onchange="updateRole(${index}, 'title', this.value)"></td>
                    <td>$<input type="number" value="${role.salary}" class="role-salary" onchange="updateRole(${index}, 'salary', this.value)"></td>
                    <td>$<span class="role-burdened">${role.burdened.toLocaleString()}</span></td>
                    <td>$<span class="role-hourly">${role.hourly.toFixed(2)}</span>/hr</td>
                    <td><button class="btn-remove" onclick="removeRole(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateRole(index, field, value) {
            if (field === 'salary') {
                const salary = parseFloat(value) || 0;
                const burdenPercent = parseFloat(document.getElementById('burdenPercent').value) || 35;
                const burdened = Math.round(salary * (1 + burdenPercent / 100));
                const hourly = (burdened / 2080);
                
                roles[index].salary = salary;
                roles[index].burdened = burdened;
                roles[index].hourly = hourly;
            } else {
                roles[index][field] = value;
            }
            
            renderRoleTable();
            renderManualSteps();
            renderAutomatedSteps();
            updateCalculations();
        }
        
        function updateRoles() {
            const burdenPercent = parseFloat(document.getElementById('burdenPercent').value) || 35;
            roles.forEach(role => {
                role.burdened = Math.round(role.salary * (1 + burdenPercent / 100));
                role.hourly = (role.burdened / 2080);
            });
            renderRoleTable();
            renderManualSteps();
            renderAutomatedSteps();
            updateCalculations();
        }
        
        function addRole() {
            roles.push({ title: "New Role", salary: 75000, burdened: 101250, hourly: 48.68 });
            renderRoleTable();
            updateCalculations();
        }
        
        function removeRole(index) {
            if (roles.length > 1) {
                roles.splice(index, 1);
                renderRoleTable();
                renderManualSteps();
                renderAutomatedSteps();
                updateCalculations();
            } else {
                alert('Cannot remove the last role.');
            }
        }
        
        // Manual steps functions
        function renderManualSteps() {
            const tbody = document.getElementById('manualProcessBody');
            tbody.innerHTML = '';
            
            let totalTime = 0;
            let totalCost = 0;
            
            manualSteps.forEach((step, index) => {
                const role = roles[step.role] || roles[0];
                const cost = role ? (role.hourly * step.time / 60) : 0;
                totalTime += step.time;
                totalCost += cost;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${step.step}" onchange="updateManualStep(${index}, 'step', this.value)"></td>
                    <td>
                        <select onchange="updateManualStep(${index}, 'role', this.value)">
                            ${roles.map((r, i) => `<option value="${i}" ${i === step.role ? 'selected' : ''}>${r.title}</option>`).join('')}
                        </select>
                    </td>
                    <td>${role ? role.hourly.toFixed(2) : '0.00'}</td>
                    <td><input type="number" value="${step.time}" onchange="updateManualStep(${index}, 'time', this.value)"></td>
                    <td>${cost.toFixed(2)}</td>
                    <td><button class="btn-remove" onclick="removeManualStep(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'highlight';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td></td>
                <td></td>
                <td><strong>${totalTime} minutes (${(totalTime/60).toFixed(2)} hrs)</strong></td>
                <td><strong>${totalCost.toFixed(2)}</strong></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
            
            updateRoleAssumptions();
        }
        
        function updateRoleAssumptions() {
            const ul = document.getElementById('roleAssumptions');
            ul.innerHTML = roles.map(r => 
                `<li>${r.title}: ${(r.burdened/1000).toFixed(0)}k fully loaded √∑ 2,080 hours = ${r.hourly.toFixed(2)}/hour</li>`
            ).join('');
        }
        
        function addManualStep() {
            manualSteps.push({ step: "New Process Step", role: 0, time: 10 });
            renderManualSteps();
            updateCalculations();
        }
        
        function updateManualStep(index, field, value) {
            if (field === 'role' || field === 'time') {
                manualSteps[index][field] = parseInt(value);
            } else {
                manualSteps[index][field] = value;
            }
            renderManualSteps();
            updateCalculations();
        }
        
        function removeManualStep(index) {
            manualSteps.splice(index, 1);
            renderManualSteps();
            updateCalculations();
        }
        
        // Automated steps functions
        function renderAutomatedSteps() {
            const tbody = document.getElementById('automatedProcessBody');
            tbody.innerHTML = '';
            
            let totalTime = 0;
            let totalCost = 0;
            const aiCostPerProcess = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            
            automatedSteps.forEach((step, index) => {
                let humanInvolvement = 'None';
                let cost = 0;
                
                if (step.role >= 0 && roles[step.role]) {
                    const role = roles[step.role];
                    humanInvolvement = role.title;
                    cost = (role.hourly * step.time / 60);
                    totalTime += step.time;
                } else if (step.isAI) {
                    humanInvolvement = 'None (AI Agent)';
                    cost = aiCostPerProcess;
                }
                
                totalCost += cost;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${step.step}" onchange="updateAutomatedStep(${index}, 'step', this.value)"></td>
                    <td>
                        <select onchange="updateAutomatedStep(${index}, 'role', this.value)">
                            <option value="-1" ${step.role === -1 ? 'selected' : ''}>None${step.isAI ? ' (AI Agent)' : ''}</option>
                            ${roles.map((r, i) => `<option value="${i}" ${i === step.role ? 'selected' : ''}>${r.title}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${step.time}" onchange="updateAutomatedStep(${index}, 'time', this.value)"></td>
                    <td>${cost.toFixed(2)}</td>
                    <td><input type="text" value="${step.feature}" onchange="updateAutomatedStep(${index}, 'feature', this.value)"></td>
                    <td><button class="btn-remove" onclick="removeAutomatedStep(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'savings';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td></td>
                <td><strong>${totalTime} minutes</strong></td>
                <td><strong>${totalCost.toFixed(2)}</strong></td>
                <td></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }
        
        function addAutomatedStep() {
            automatedSteps.push({ step: "New Automated Step", role: -1, time: 0, feature: "Automation", isAI: false });
            renderAutomatedSteps();
            updateCalculations();
        }
        
        function updateAutomatedStep(index, field, value) {
            if (field === 'role' || field === 'time') {
                automatedSteps[index][field] = parseInt(value);
                if (field === 'role' && value === '-1') {
                    if (automatedSteps[index].feature.toLowerCase().includes('ai') || 
                        automatedSteps[index].feature.toLowerCase().includes('gpt')) {
                        automatedSteps[index].isAI = true;
                    } else {
                        automatedSteps[index].isAI = false;
                    }
                }
            } else {
                automatedSteps[index][field] = value;
                if (field === 'feature') {
                    automatedSteps[index].isAI = value.toLowerCase().includes('ai') || 
                                                 value.toLowerCase().includes('gpt');
                }
            }
            renderAutomatedSteps();
            updateCalculations();
        }
        
        function removeAutomatedStep(index) {
            automatedSteps.splice(index, 1);
            renderAutomatedSteps();
            updateCalculations();
        }
        
        // Operating costs functions
        function renderOperatingCosts() {
            const tbody = document.getElementById('operatingCostsBody');
            tbody.innerHTML = '';
            
            let totalMonthly = 0;
            let totalAnnual = 0;
            
            operatingCosts.forEach((cost, index) => {
                totalMonthly += cost.monthly;
                totalAnnual += cost.monthly * 12;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${cost.name}" onchange="updateOperatingCost(${index}, 'name', this.value)"></td>
                    <td>$<input type="number" value="${cost.monthly}" onchange="updateOperatingCost(${index}, 'monthly', this.value)"></td>
                    <td>${(cost.monthly * 12).toLocaleString()}</td>
                    <td><input type="text" value="${cost.notes}" onchange="updateOperatingCost(${index}, 'notes', this.value)"></td>
                    <td><button class="btn-remove" onclick="removeOperatingCost(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add AI token cost row
            const aiCost = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            const aiMonthly = aiCost * monthlyVolume;
            
            const aiRow = document.createElement('tr');
            aiRow.innerHTML = `
                <td>AI Token Usage (${monthlyVolume} clients/month)</td>
                <td>${aiMonthly.toFixed(0)}</td>
                <td>${(aiMonthly * 12).toFixed(0)}</td>
                <td>~${aiCost.toFixed(2)} per client √ó ${monthlyVolume}</td>
                <td></td>
            `;
            tbody.appendChild(aiRow);
            
            totalMonthly += aiMonthly;
            totalAnnual += aiMonthly * 12;
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'highlight';
            totalRow.innerHTML = `
                <td><strong>Total Operating Costs</strong></td>
                <td><strong>${totalMonthly.toFixed(0)}</strong></td>
                <td><strong>${totalAnnual.toFixed(0)}</strong></td>
                <td></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }
        
        function addOperatingCost() {
            operatingCosts.push({ name: "New Operating Cost", monthly: 100, notes: "Description" });
            renderOperatingCosts();
            updateCalculations();
        }
        
        function updateOperatingCost(index, field, value) {
            if (field === 'monthly') {
                operatingCosts[index][field] = parseFloat(value) || 0;
            } else {
                operatingCosts[index][field] = value;
            }
            renderOperatingCosts();
            updateCalculations();
        }
        
        function removeOperatingCost(index) {
            operatingCosts.splice(index, 1);
            renderOperatingCosts();
            updateCalculations();
        }
        
        // SAXTech Resources functions
        function renderSAXTechResources() {
            const tbody = document.getElementById('saxTechResourcesBody');
            tbody.innerHTML = '';
            
            saxTechResources.forEach((resource, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${resource.type}" onchange="updateSAXTechResource(${index}, 'type', this.value)"></td>
                    <td><input type="text" value="${resource.role}" onchange="updateSAXTechResource(${index}, 'role', this.value)"></td>
                    <td>$<input type="number" value="${resource.rate}" onchange="updateSAXTechResource(${index}, 'rate', this.value)"></td>
                    <td><input type="text" value="${resource.tasks}" onchange="updateSAXTechResource(${index}, 'tasks', this.value)"></td>
                    <td><button class="btn-remove" onclick="removeSAXTechResource(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update the resource selector dropdown
            updateResourceSelector();
        }
        
        function updateResourceSelector() {
            const selector = document.getElementById('saxTechResourceSelector');
            if (selector) {
                selector.innerHTML = '<option value="">Select a SAXTech resource...</option>';
                saxTechResources.forEach((resource, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${resource.type} (${resource.role}) - $${resource.rate}/hr`;
                    selector.appendChild(option);
                });
            }
        }
        
        function addSAXTechResource() {
            saxTechResources.push({ 
                type: "New Resource Type", 
                role: "Mid", 
                rate: 150, 
                tasks: "Define tasks for this resource",
                expertise: "Define expertise areas"
            });
            renderSAXTechResources();
        }
        
        function updateSAXTechResource(index, field, value) {
            if (field === 'rate') {
                saxTechResources[index][field] = parseFloat(value) || 0;
            } else {
                saxTechResources[index][field] = value;
            }
            renderSAXTechResources();
            renderImplementationCosts(); // Re-render in case any existing components reference this resource
        }
        
        function removeSAXTechResource(index) {
            if (saxTechResources.length > 1) {
                saxTechResources.splice(index, 1);
                renderSAXTechResources();
            } else {
                alert('Cannot remove the last SAXTech resource.');
            }
        }
        
        function addSelectedResource() {
            const selector = document.getElementById('saxTechResourceSelector');
            const hoursInput = document.getElementById('resourceHours');
            
            const resourceIndex = parseInt(selector.value);
            const hours = parseFloat(hoursInput.value) || 0;
            
            if (resourceIndex >= 0 && hours > 0) {
                const resource = saxTechResources[resourceIndex];
                const componentName = `${resource.type} - ${resource.tasks.split(',')[0].trim()}`;
                
                implementationComponents.push({
                    name: componentName,
                    hours: hours,
                    rate: resource.rate,
                    resourceType: resource.type
                });
                
                renderImplementationCosts();
                updateCalculations();
                
                // Reset form
                selector.value = '';
                hoursInput.value = '';
                
                addMessage('system', `Added ${hours} hours of ${resource.type} to implementation plan.`);
            } else {
                alert('Please select a resource and enter hours.');
            }
        }
        
        // Implementation costs functions
        function renderImplementationCosts() {
            const tbody = document.getElementById('implementationCostsBody');
            tbody.innerHTML = '';
            
            let totalHours = 0;
            let totalCost = 0;
            
            implementationComponents.forEach((comp, index) => {
                const cost = comp.hours * comp.rate;
                totalHours += comp.hours;
                totalCost += cost;
                
                const resourceType = comp.resourceType || 'Custom';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${comp.name}" onchange="updateImplementationComponent(${index}, 'name', this.value)"></td>
                    <td><input type="number" value="${comp.hours}" onchange="updateImplementationComponent(${index}, 'hours', this.value)"></td>
                    <td>$<input type="number" value="${comp.rate}" onchange="updateImplementationComponent(${index}, 'rate', this.value)"></td>
                    <td>$${cost.toLocaleString()}</td>
                    <td><span style="font-size: 0.9em; color: #666;">${resourceType}</span></td>
                    <td><button class="btn-remove" onclick="removeImplementationComponent(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add project management (15% of total)
            const pmHours = Math.round(totalHours * 0.15);
            const avgRate = totalHours > 0 ? totalCost / totalHours : 150;
            const pmCost = pmHours * avgRate;
            
            const pmRow = document.createElement('tr');
            pmRow.innerHTML = `
                <td>Project Management (15%)</td>
                <td>${pmHours}</td>
                <td>${avgRate.toFixed(0)}</td>
                <td>${pmCost.toLocaleString()}</td>
                <td></td>
            `;
            tbody.appendChild(pmRow);
            
            totalHours += pmHours;
            totalCost += pmCost;
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'highlight';
            totalRow.innerHTML = `
                <td><strong>Total Implementation</strong></td>
                <td><strong>${totalHours}</strong></td>
                <td></td>
                <td><strong>${totalCost.toLocaleString()}</strong></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
            
            // Update display
            document.getElementById('displayImplementationCost').textContent = totalCost.toLocaleString();
        }
        
        function addImplementationComponent() {
            implementationComponents.push({ name: "New Component", hours: 20, rate: 150, resourceType: "Custom" });
            renderImplementationCosts();
            updateCalculations();
        }
        
        function updateImplementationComponent(index, field, value) {
            if (field === 'hours' || field === 'rate') {
                implementationComponents[index][field] = parseFloat(value) || 0;
            } else {
                implementationComponents[index][field] = value;
            }
            renderImplementationCosts();
            updateCalculations();
        }
        
        function removeImplementationComponent(index) {
            implementationComponents.splice(index, 1);
            renderImplementationCosts();
            updateCalculations();
        }
        
        // Monthly service costs functions
        function renderMonthlyServiceCosts() {
            const tbody = document.getElementById('monthlyServiceBody');
            tbody.innerHTML = '';
            
            let totalHours = 0;
            let totalCost = 0;
            
            monthlyServiceComponents.forEach((comp, index) => {
                const cost = comp.fixedCost || (comp.hours * comp.rate);
                totalHours += comp.hours;
                totalCost += cost;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${comp.name}" onchange="updateMonthlyServiceComponent(${index}, 'name', this.value)"></td>
                    <td><input type="number" value="${comp.hours}" onchange="updateMonthlyServiceComponent(${index}, 'hours', this.value)"></td>
                    <td>$<input type="number" value="${comp.rate}" onchange="updateMonthlyServiceComponent(${index}, 'rate', this.value)"></td>
                    <td>${cost.toLocaleString()}</td>
                    <td><button class="btn-remove" onclick="removeMonthlyServiceComponent(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add operating costs with markup section
            let operatingTotal = 0;
            operatingCosts.forEach(cost => {
                operatingTotal += cost.monthly;
            });
            
            // Add AI costs
            const aiCostPerProcess = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            operatingTotal += aiCostPerProcess * monthlyVolume;
            
            // Add operating costs with dynamic markup
            const markupPercent = parseFloat(document.getElementById('infrastructureMarkup').value) || 20;
            const infrastructureCost = Math.round(operatingTotal * (1 + markupPercent / 100));
            
            const infraRow = document.createElement('tr');
            infraRow.style.backgroundColor = '#f0f8ff';
            infraRow.innerHTML = `
                <td>Infrastructure Management (${markupPercent}% markup)</td>
                <td>-</td>
                <td>-</td>
                <td>${infrastructureCost.toLocaleString()}</td>
                <td><span style="font-size: 0.85em; color: #666;">Includes AI + hosting costs</span></td>
            `;
            tbody.appendChild(infraRow);
            totalCost += infrastructureCost;
            
            // Add monthly custom add-ons
            customAddons.forEach((addon, index) => {
                if (addon.frequency === 'monthly') {
                    const addonRow = document.createElement('tr');
                    addonRow.style.backgroundColor = '#f8f9fa';
                    addonRow.innerHTML = `
                        <td>${addon.name} (Monthly Add-on)</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${addon.amount.toLocaleString()}</td>
                        <td><span style="font-size: 0.85em; color: #666;">${addon.unit}</span></td>
                    `;
                    tbody.appendChild(addonRow);
                    totalCost += addon.amount;
                }
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'highlight';
            totalRow.innerHTML = `
                <td><strong>Total Monthly Service Fee</strong></td>
                <td><strong>${totalHours}</strong></td>
                <td></td>
                <td><strong>$${totalCost.toLocaleString()}</strong></td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
            
            // Update display with calculated total (don't override here since updateCalculations will handle it)
        }
        
        function addMonthlyServiceComponent() {
            monthlyServiceComponents.push({ name: "New Service Component", hours: 5, rate: 125, fixedCost: null });
            renderMonthlyServiceCosts();
            updateCalculations();
        }
        
        function updateMonthlyServiceComponent(index, field, value) {
            if (field === 'hours' || field === 'rate') {
                monthlyServiceComponents[index][field] = parseFloat(value) || 0;
                monthlyServiceComponents[index].fixedCost = null; // Clear fixed cost if editing hours/rate
            } else {
                monthlyServiceComponents[index][field] = value;
            }
            renderMonthlyServiceCosts();
            updateCalculations();
        }
        
        function removeMonthlyServiceComponent(index) {
            monthlyServiceComponents.splice(index, 1);
            renderMonthlyServiceCosts();
            updateCalculations();
        }
        
        // Custom add-ons functions
        function renderCustomAddons() {
            const tbody = document.getElementById('customAddonsBody');
            tbody.innerHTML = '';
            
            customAddons.forEach((addon, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${addon.name}" onchange="updateCustomAddon(${index}, 'name', this.value)"></td>
                    <td>
                        <select onchange="updateCustomAddon(${index}, 'frequency', this.value)">
                            <option value="one-time" ${addon.frequency === 'one-time' ? 'selected' : ''}>One-time</option>
                            <option value="monthly" ${addon.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                        </select>
                    </td>
                    <td>$<input type="number" value="${addon.amount}" onchange="updateCustomAddon(${index}, 'amount', this.value)"></td>
                    <td><input type="text" value="${addon.unit}" onchange="updateCustomAddon(${index}, 'unit', this.value)"></td>
                    <td><button class="btn-remove" onclick="removeCustomAddon(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update add-ons list in pricing section
            const addonsList = document.getElementById('addonsList');
            addonsList.innerHTML = customAddons.map(addon => {
                const frequency = addon.frequency === 'monthly' ? '/month' : ' one-time';
                return `<li><strong>${addon.name}:</strong> $${addon.amount.toLocaleString()}${frequency}</li>`;
            }).join('');
        }
        
        function addCustomAddon() {
            customAddons.push({ name: "New Add-on", frequency: "one-time", amount: 1000, unit: "description" });
            renderCustomAddons();
            updateCalculations();
        }
        
        function updateCustomAddon(index, field, value) {
            if (field === 'amount') {
                customAddons[index][field] = parseFloat(value) || 0;
            } else {
                customAddons[index][field] = value;
            }
            renderCustomAddons();
            updateCalculations();
        }
        
        function removeCustomAddon(index) {
            customAddons.splice(index, 1);
            renderCustomAddons();
            updateCalculations();
        }
        
        // AI pricing functions
        function selectAIModel(model, element) {
            selectedAIModel = model;
            document.querySelectorAll('.ai-model-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            updateAIPricing();
        }
        
        function estimateTokens() {
            const pages = parseFloat(document.getElementById('docPages').value) || 3;
            const complexity = document.getElementById('complexity').value;
            
            let inputTokens = pages * 750; // ~750 tokens per page
            let outputTokens = 500; // Base output
            
            switch(complexity) {
                case 'simple':
                    outputTokens = 300;
                    break;
                case 'medium':
                    outputTokens = 750;
                    break;
                case 'complex':
                    outputTokens = 1500;
                    break;
            }
            
            document.getElementById('inputTokens').value = inputTokens;
            document.getElementById('outputTokens').value = outputTokens;
            updateAIPricing();
        }
        
        function updateAIPricing() {
            const inputTokens = parseFloat(document.getElementById('inputTokens').value) || 0;
            const outputTokens = parseFloat(document.getElementById('outputTokens').value) || 0;
            const aiCalls = parseFloat(document.getElementById('aiCalls').value) || 0;
            
            const pricing = aiPricing[selectedAIModel];
            const inputCost = (inputTokens * aiCalls * pricing.input / 1000);
            const outputCost = (outputTokens * aiCalls * pricing.output / 1000);
            const totalCost = inputCost + outputCost;
            
            document.getElementById('aiCostPerProcess').textContent = totalCost.toFixed(2);
            
            // Update calculation display
            document.getElementById('calcInputTokens').textContent = inputTokens;
            document.getElementById('calcOutputTokens').textContent = outputTokens;
            document.getElementById('calcAICalls').textContent = aiCalls;
            document.getElementById('calcAICalls2').textContent = aiCalls;
            document.getElementById('calcInputPrice').textContent = (pricing.input / 1000).toFixed(6);
            document.getElementById('calcOutputPrice').textContent = (pricing.output / 1000).toFixed(6);
            document.getElementById('calcInputCost').textContent = inputCost.toFixed(4);
            document.getElementById('calcOutputCost').textContent = outputCost.toFixed(4);
            document.getElementById('calcTotalCost').textContent = totalCost.toFixed(2);
            
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            document.getElementById('calcMonthlyCost').textContent = (totalCost * monthlyVolume).toFixed(2);
            document.getElementById('calcAnnualCost').textContent = (totalCost * monthlyVolume * 12).toFixed(2);
            
            renderAutomatedSteps();
            renderOperatingCosts();
            updateCalculations();
        }
        
        // Update competitive analysis when calculations change
        function updateCompetitiveAnalysis() {
            // Find and update SAXTech row
            const saxTechIndex = competitiveAnalysis.findIndex(c => c.isSAXTech);
            if (saxTechIndex >= 0) {
                const implementation = calculateImplementationCost();
                const monthly = calculateMonthlyServiceFee();
                const annual = implementation + (monthly * 12) + calculateAnnualOperatingCosts();
                
                competitiveAnalysis[saxTechIndex].implementation = implementation;
                competitiveAnalysis[saxTechIndex].monthly = monthly;
                competitiveAnalysis[saxTechIndex].annual = annual;
            }
            renderCompetitiveAnalysis();
        }
        
        // Main calculation function
        function updateCalculations() {
            // Update client name and process name
            document.getElementById('clientName').textContent = document.getElementById('inputClientName').value;
            document.getElementById('processName').textContent = document.getElementById('inputProcessName').value;
            
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            const annualVolume = monthlyVolume * 12;
            
            // Update volume displays
            document.querySelectorAll('.monthly-volume').forEach(el => el.textContent = monthlyVolume);
            document.querySelectorAll('.annual-volume').forEach(el => el.textContent = annualVolume);
            
            // Calculate manual process totals
            let manualTotalTime = 0;
            let manualTotalCost = 0;
            manualSteps.forEach(step => {
                if (roles[step.role]) {
                    const role = roles[step.role];
                    manualTotalTime += step.time;
                    manualTotalCost += (role.hourly * step.time / 60);
                }
            });
            
            // Calculate automated process totals
            let autoTotalTime = 0;
            let autoTotalCost = 0;
            const aiCostPerProcess = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            
            automatedSteps.forEach(step => {
                if (step.role >= 0 && roles[step.role]) {
                    const role = roles[step.role];
                    autoTotalTime += step.time;
                    autoTotalCost += (role.hourly * step.time / 60);
                } else if (step.isAI) {
                    autoTotalCost += aiCostPerProcess;
                }
            });
            
            // Calculate savings metrics
            const timeSavingsPercent = manualTotalTime > 0 ? ((manualTotalTime - autoTotalTime) / manualTotalTime * 100).toFixed(1) : 0;
            const timeSavingsMinutes = manualTotalTime - autoTotalTime;
            const costSavingsPerClient = manualTotalCost - autoTotalCost;
            const speedImprovement = autoTotalTime > 0 ? Math.round(manualTotalTime / autoTotalTime) : Math.round(manualTotalTime / 1);
            
            // Update metric displays
            document.getElementById('timeSavingsPercent').textContent = timeSavingsPercent;
            document.getElementById('timeSavingsMinutes').textContent = timeSavingsMinutes.toFixed(0);
            document.getElementById('costSavingsPerClient').textContent = costSavingsPerClient.toFixed(2);
            document.getElementById('speedImprovement').textContent = speedImprovement;
            document.getElementById('oldHours').textContent = (manualTotalTime / 60).toFixed(2);
            document.getElementById('newMinutes').textContent = autoTotalTime.toFixed(0);
            
            // Update annual impact
            document.getElementById('monthlyVolumeManual').textContent = monthlyVolume;
            document.getElementById('monthlyVolumeAuto').textContent = monthlyVolume;
            document.getElementById('annualVolumeManual').textContent = annualVolume;
            document.getElementById('annualVolumeAuto').textContent = annualVolume;
            
            document.getElementById('hoursPerClientManual').textContent = (manualTotalTime / 60).toFixed(2);
            document.getElementById('hoursPerClientAuto').textContent = (autoTotalTime / 60).toFixed(2);
            document.getElementById('hoursPerClientSaved').textContent = ((manualTotalTime - autoTotalTime) / 60).toFixed(2);
            
            document.getElementById('annualHoursManual').textContent = (manualTotalTime / 60 * annualVolume).toFixed(0);
            document.getElementById('annualHoursAuto').textContent = (autoTotalTime / 60 * annualVolume).toFixed(0);
            document.getElementById('annualHoursSaved').textContent = ((manualTotalTime - autoTotalTime) / 60 * annualVolume).toFixed(0);
            
            document.getElementById('costPerClientManual').textContent = manualTotalCost.toFixed(2);
            document.getElementById('costPerClientAuto').textContent = autoTotalCost.toFixed(2);
            document.getElementById('costPerClientSaved').textContent = costSavingsPerClient.toFixed(2);
            
            const annualManualCost = manualTotalCost * annualVolume;
            const annualAutoCost = autoTotalCost * annualVolume;
            const annualCostSaved = annualManualCost - annualAutoCost;
            
            document.getElementById('annualCostManual').textContent = annualManualCost.toFixed(0);
            document.getElementById('annualCostAuto').textContent = annualAutoCost.toFixed(0);
            document.getElementById('annualCostSaved').textContent = annualCostSaved.toFixed(0);
            
            // Calculate implementation cost
            let implementationCost = 0;
            implementationComponents.forEach(comp => {
                implementationCost += comp.hours * comp.rate;
            });
            implementationCost = implementationCost * 1.15; // Add 15% PM
            
            // Calculate monthly service fee (including infrastructure costs)
            const monthlyServiceFee = calculateMonthlyServiceFee();
            
            // Calculate annual operating costs (separate from monthly service fee)
            const totalOperatingCosts = 0; // Operating costs are now included in monthly service fee
            
            const contractLength = parseFloat(document.getElementById('contractLength').value) || 24;
            const annualServiceCost = monthlyServiceFee * 12;
            
            // Update displays
            document.getElementById('displayContractLength').textContent = contractLength;
            document.getElementById('displayMonthlyFee').textContent = monthlyServiceFee.toLocaleString();
            document.getElementById('displayImplementationCost').textContent = implementationCost.toLocaleString();
            document.getElementById('formulaLaborSavings').textContent = annualCostSaved.toLocaleString();
            document.getElementById('formulaOperatingCosts').textContent = '0'; // Infrastructure costs now included in monthly service fee
            document.getElementById('formulaMonthlyService').textContent = monthlyServiceFee.toLocaleString();
            document.getElementById('formulaAnnualService').textContent = annualServiceCost.toLocaleString();
            
            const netAnnualSavings = annualCostSaved - annualServiceCost; // No separate operating costs
            document.getElementById('netAnnualSavings').textContent = netAnnualSavings.toLocaleString();
            
            // Update executive summary
            document.getElementById('annualSavings').textContent = Math.round(annualCostSaved).toLocaleString();
            document.getElementById('timeReduction').textContent = timeSavingsPercent;
            
            // Calculate partner hours freed
            let partnerMinutes = 0;
            manualSteps.forEach(step => {
                if (step.role === 0) { // Assuming first role is Partner
                    partnerMinutes += step.time;
                }
            });
            const partnerHoursFreed = Math.round(partnerMinutes / 60 * annualVolume);
            document.getElementById('partnerHoursFreed').textContent = partnerHoursFreed;
            
            // Calculate payback and ROI
            const totalY1Investment = implementationCost + annualServiceCost; // Operating costs included in monthly service fee
            const totalBenefitsY1 = annualCostSaved + 15000 + 20000; // Add qualitative benefits
            const monthlyBenefit = totalBenefitsY1 / 12;
            const paybackMonths = monthlyBenefit > 0 ? totalY1Investment / monthlyBenefit : 0;
            const roiPercentY1 = totalY1Investment > 0 ? ((totalBenefitsY1 - totalY1Investment) / totalY1Investment * 100).toFixed(0) : 0;
            
            document.getElementById('paybackPeriod').textContent = paybackMonths.toFixed(1);
            document.getElementById('paybackMonths').textContent = paybackMonths.toFixed(1);
            document.getElementById('firstYearROI').textContent = roiPercentY1;
            
            // Update ROI table
            document.getElementById('roiImplementationY1').textContent = implementationCost.toLocaleString();
            document.getElementById('roiServiceY1').textContent = annualServiceCost.toLocaleString();
            document.getElementById('roiOperatingY1').textContent = '0'; // Operating costs included in monthly service fee
            document.getElementById('roiTotalInvestY1').textContent = totalY1Investment.toLocaleString();
            
            document.getElementById('roiLaborY1').textContent = annualCostSaved.toLocaleString();
            document.getElementById('roiTotalBenefitsY1').textContent = totalBenefitsY1.toLocaleString();
            document.getElementById('roiNetY1').textContent = (totalBenefitsY1 - totalY1Investment).toLocaleString();
            document.getElementById('roiPercentY1').textContent = roiPercentY1;
            
            // Year 2
            const totalY2Investment = annualServiceCost; // Operating costs included in monthly service fee
            document.getElementById('roiServiceY2').textContent = annualServiceCost.toLocaleString();
            document.getElementById('roiOperatingY2').textContent = '0'; // Operating costs included in monthly service fee
            document.getElementById('roiTotalInvestY2').textContent = totalY2Investment.toLocaleString();
            document.getElementById('roiLaborY2').textContent = annualCostSaved.toLocaleString();
            document.getElementById('roiTotalBenefitsY2').textContent = totalBenefitsY1.toLocaleString();
            document.getElementById('roiNetY2').textContent = (totalBenefitsY1 - totalY2Investment).toLocaleString();
            document.getElementById('roiPercentY2').textContent = totalY2Investment > 0 ? ((totalBenefitsY1 - totalY2Investment) / totalY2Investment * 100).toFixed(0) : 0;
            
            // 3 Year totals
            document.getElementById('roiImplementation3Y').textContent = implementationCost.toLocaleString();
            document.getElementById('roiService3Y').textContent = (annualServiceCost * 3).toLocaleString();
            document.getElementById('roiOperating3Y').textContent = '0'; // Operating costs included in monthly service fee
            
            const total3YInvest = implementationCost + annualServiceCost * 3; // Operating costs included in monthly service fee
            const total3YBenefits = totalBenefitsY1 * 3;
            document.getElementById('roiTotalInvest3Y').textContent = total3YInvest.toLocaleString();
            document.getElementById('roiLabor3Y').textContent = (annualCostSaved * 3).toLocaleString();
            document.getElementById('roiTotalBenefits3Y').textContent = total3YBenefits.toLocaleString();
            document.getElementById('roiNet3Y').textContent = (total3YBenefits - total3YInvest).toLocaleString();
            document.getElementById('roiPercent3Y').textContent = total3YInvest > 0 ? ((total3YBenefits - total3YInvest) / total3YInvest * 100).toFixed(0) : 0;
            
            // Update executive recommendation
            document.getElementById('execClientName').textContent = document.getElementById('inputClientName').value;
            document.getElementById('execProcessName').textContent = document.getElementById('inputProcessName').value.toLowerCase();
            document.getElementById('execY1Investment').textContent = totalY1Investment.toLocaleString();
            document.getElementById('execY1Savings').textContent = (totalBenefitsY1 - totalY1Investment).toLocaleString();
            document.getElementById('execPayback').textContent = paybackMonths.toFixed(1);
            document.getElementById('exec3YearROI').textContent = total3YInvest > 0 ? ((total3YBenefits - total3YInvest) / total3YInvest * 100).toFixed(0) : 0;
            document.getElementById('execTimeReduction').textContent = timeSavingsPercent;
            document.getElementById('execPartnerHours').textContent = partnerHoursFreed;
            document.getElementById('execContractLength').textContent = contractLength;
            
            // Update competitive analysis with new calculations
            updateCompetitiveAnalysis();
        }
        
        // Timeline management functions
        function renderTimeline() {
            const tbody = document.getElementById('timelineBody');
            tbody.innerHTML = '';
            
            let totalDuration = 0;
            
            timelinePhases.forEach((phase, index) => {
                totalDuration += phase.duration;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${phase.phase}" onchange="updateTimelinePhase(${index}, 'phase', this.value)"></td>
                    <td><input type="number" step="0.5" value="${phase.duration}" onchange="updateTimelinePhase(${index}, 'duration', this.value)"></td>
                    <td><textarea style="min-height: 60px;" onchange="updateTimelinePhase(${index}, 'activities', this.value)">${phase.activities}</textarea></td>
                    <td><textarea style="min-height: 60px;" onchange="updateTimelinePhase(${index}, 'deliverables', this.value)">${phase.deliverables}</textarea></td>
                    <td><button class="btn-remove" onclick="removeTimelinePhase(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary
            document.getElementById('totalDuration').textContent = totalDuration;
            document.getElementById('totalPhases').textContent = timelinePhases.length;
        }
        
        function addTimelinePhase() {
            timelinePhases.push({
                phase: "New Phase",
                duration: 1,
                activities: "Define activities for this phase",
                deliverables: "Define deliverables for this phase"
            });
            renderTimeline();
        }
        
        function updateTimelinePhase(index, field, value) {
            if (field === 'duration') {
                timelinePhases[index][field] = parseFloat(value) || 0;
            } else {
                timelinePhases[index][field] = value;
            }
            renderTimeline();
        }
        
        function removeTimelinePhase(index) {
            if (timelinePhases.length > 1) {
                timelinePhases.splice(index, 1);
                renderTimeline();
            } else {
                alert('Cannot remove the last timeline phase.');
            }
        }
        
        // Competitive Analysis functions
        function renderCompetitiveAnalysis() {
            const tbody = document.getElementById('competitiveAnalysisBody');
            tbody.innerHTML = '';
            
            competitiveAnalysis.forEach((competitor, index) => {
                let implementation = competitor.implementation;
                let monthly = competitor.monthly;
                let annual = competitor.annual;
                
                // Update SAXTech row with calculated values
                if (competitor.isSAXTech) {
                    implementation = calculateImplementationCost();
                    monthly = calculateMonthlyServiceFee();
                    annual = implementation + (monthly * 12) + calculateAnnualOperatingCosts();
                    
                    // Update the stored values
                    competitiveAnalysis[index].implementation = implementation;
                    competitiveAnalysis[index].monthly = monthly;
                    competitiveAnalysis[index].annual = annual;
                }
                
                const row = document.createElement('tr');
                row.className = competitor.isSAXTech ? 'highlight' : '';
                row.innerHTML = `
                    <td><strong>${competitor.provider}</strong></td>
                    <td>$${implementation.toLocaleString()}</td>
                    <td>$${monthly.toLocaleString()}</td>
                    <td>$${annual.toLocaleString()}</td>
                    <td><textarea style="min-height: 80px; white-space: pre-line;" onchange="updateCompetitor(${index}, 'proscons', this.value)" ${competitor.isSAXTech ? 'readonly' : ''}>${competitor.proscons}</textarea></td>
                    <td>${competitor.isSAXTech ? '<span style="color: #666;">SAXTech</span>' : `<button class="btn-remove" onclick="removeCompetitor(${index})">Remove</button>`}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Update cost comparison
            const saxTechAnnual = competitiveAnalysis.find(c => c.isSAXTech)?.annual || 0;
            const big4Annual = competitiveAnalysis.find(c => c.provider.includes('Big 4'))?.annual || 210000;
            const percentage = big4Annual > 0 ? Math.round((saxTechAnnual / big4Annual) * 100) : 33;
            document.getElementById('costComparison').textContent = `${percentage}% of Big 4 cost`;
        }
        
        function addCompetitor() {
            competitiveAnalysis.push({
                provider: "New Competitor",
                implementation: 50000,
                monthly: 2000,
                annual: 74000,
                proscons: "‚úì Add pros\n‚úó Add cons",
                isSAXTech: false
            });
            renderCompetitiveAnalysis();
        }
        
        function updateCompetitor(index, field, value) {
            if (!competitiveAnalysis[index].isSAXTech) {
                if (field === 'implementation' || field === 'monthly') {
                    const numValue = parseFloat(value) || 0;
                    competitiveAnalysis[index][field] = numValue;
                    // Recalculate annual
                    competitiveAnalysis[index].annual = competitiveAnalysis[index].implementation + (competitiveAnalysis[index].monthly * 12);
                } else {
                    competitiveAnalysis[index][field] = value;
                }
                renderCompetitiveAnalysis();
            }
        }
        
        function removeCompetitor(index) {
            if (!competitiveAnalysis[index].isSAXTech) {
                competitiveAnalysis.splice(index, 1);
                renderCompetitiveAnalysis();
            }
        }
        
        // Risk Mitigation functions
        function renderRiskMitigation() {
            const tbody = document.getElementById('riskMitigationBody');
            tbody.innerHTML = '';
            
            riskFactors.forEach((risk, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${risk.risk}" onchange="updateRiskFactor(${index}, 'risk', this.value)"></td>
                    <td>
                        <select onchange="updateRiskFactor(${index}, 'probability', this.value)">
                            <option value="Low" ${risk.probability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${risk.probability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${risk.probability === 'High' ? 'selected' : ''}>High</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateRiskFactor(${index}, 'impact', this.value)">
                            <option value="Low" ${risk.impact === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${risk.impact === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${risk.impact === 'High' ? 'selected' : ''}>High</option>
                            <option value="Critical" ${risk.impact === 'Critical' ? 'selected' : ''}>Critical</option>
                        </select>
                    </td>
                    <td><textarea style="min-height: 60px;" onchange="updateRiskFactor(${index}, 'mitigation', this.value)">${risk.mitigation}</textarea></td>
                    <td><button class="btn-remove" onclick="removeRiskFactor(${index})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addRiskFactor() {
            riskFactors.push({
                risk: "New Risk Factor",
                probability: "Medium",
                impact: "Medium",
                mitigation: "Define mitigation strategy"
            });
            renderRiskMitigation();
        }
        
        function updateRiskFactor(index, field, value) {
            riskFactors[index][field] = value;
            renderRiskMitigation();
        }
        
        function removeRiskFactor(index) {
            if (riskFactors.length > 1) {
                riskFactors.splice(index, 1);
                renderRiskMitigation();
            } else {
                alert('Cannot remove the last risk factor.');
            }
        }
        
        // Helper functions for calculations
        function calculateImplementationCost() {
            let total = 0;
            implementationComponents.forEach(comp => {
                total += comp.hours * comp.rate;
            });
            
            // Add one-time custom add-ons
            customAddons.forEach(addon => {
                if (addon.frequency === 'one-time') {
                    total += addon.amount;
                }
            });
            
            return Math.round(total * 1.15); // Add 15% PM
        }
        
        function calculateMonthlyServiceFee() {
            let total = 0;
            
            // Calculate base monthly service components (labor/support)
            monthlyServiceComponents.forEach(comp => {
                if (comp.fixedCost) {
                    // Skip fixed infrastructure costs - will be calculated dynamically
                    if (comp.name !== "Infrastructure Hosting") {
                        total += comp.fixedCost;
                    }
                } else {
                    total += comp.hours * comp.rate;
                }
            });
            
            // Add operating costs with markup
            let operatingTotal = 0;
            operatingCosts.forEach(cost => {
                operatingTotal += cost.monthly;
            });
            
            // Add AI costs
            const aiCostPerProcess = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            operatingTotal += aiCostPerProcess * monthlyVolume;
            
            // Add operating costs with dynamic markup for infrastructure management
            const markupPercent = parseFloat(document.getElementById('infrastructureMarkup').value) || 20;
            const infrastructureCost = Math.round(operatingTotal * (1 + markupPercent / 100));
            total += infrastructureCost;
            
            // Add monthly custom add-ons
            customAddons.forEach(addon => {
                if (addon.frequency === 'monthly') {
                    total += addon.amount;
                }
            });
            
            return total;
        }
        
        function calculateAnnualOperatingCosts() {
            // Operating costs are now included in monthly service fee
            return 0;
        }
        
        // Render all components function
        function renderAll() {
            console.log('Rendering all components...');
            console.log('Current data:', { roles: roles.length, manualSteps: manualSteps.length, automatedSteps: automatedSteps.length });
            
            renderRoleTable();
            renderManualSteps();
            renderAutomatedSteps();
            renderOperatingCosts();
            renderSAXTechResources();
            renderImplementationCosts();
            renderMonthlyServiceCosts();
            renderCustomAddons();
            renderTimeline();
            renderCompetitiveAnalysis();
            renderRiskMitigation();
            updateAIPricing();
            
            console.log('All components rendered');
        }
        
        // Generate PDF data from current ROI state
        function generatePDFData(currentState) {
            const clientName = currentState.clientName || 'Your Company';
            const processName = currentState.processName || 'process automation';
            const implementationCost = calculateImplementationCost();
            const monthlyServiceCost = calculateMonthlyServiceFee();
            const contractLength = parseFloat(document.getElementById('contractLength').value) || 24;
            const totalDuration = timelinePhases.reduce((sum, phase) => sum + phase.duration, 0);
            
            // Calculate ROI metrics
            let manualTotalCost = 0;
            let autoTotalCost = 0;
            let manualTotalTime = 0;
            let autoTotalTime = 0;
            const aiCostPerProcess = parseFloat(document.getElementById('aiCostPerProcess').textContent) || 0;
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            
            // Calculate from current steps
            currentState.manualSteps.forEach(step => {
                if (currentState.roles[step.role]) {
                    const role = currentState.roles[step.role];
                    manualTotalCost += (role.hourly * step.time / 60);
                    manualTotalTime += step.time;
                }
            });
            
            currentState.automatedSteps.forEach(step => {
                if (step.role >= 0 && currentState.roles[step.role]) {
                    const role = currentState.roles[step.role];
                    autoTotalCost += (role.hourly * step.time / 60);
                    autoTotalTime += step.time;
                } else if (step.isAI) {
                    autoTotalCost += aiCostPerProcess;
                }
            });
            
            const timeSavingsPercent = manualTotalTime > 0 ? ((manualTotalTime - autoTotalTime) / manualTotalTime * 100).toFixed(1) : 0;
            const annualLaborSavings = (manualTotalCost - autoTotalCost) * monthlyVolume * 12;
            const totalY1Investment = implementationCost + monthlyServiceCost * 12 + calculateAnnualOperatingCosts();
            const paybackMonths = totalY1Investment > 0 ? (totalY1Investment / (annualLaborSavings / 12)) : 0;
            const firstYearROI = totalY1Investment > 0 ? ((annualLaborSavings - totalY1Investment) / totalY1Investment * 100) : 0;
            
            // Calculate partner hours freed (assuming first role is Partner)
            let partnerMinutes = 0;
            currentState.manualSteps.forEach(step => {
                if (step.role === 0) {
                    partnerMinutes += step.time;
                }
            });
            const partnerHoursFreed = Math.round(partnerMinutes / 60 * monthlyVolume * 12);
            
            // Generate comprehensive project scope based on process analysis
            const projectScope = generateProjectScope(currentState, processName);
            const implementationPlan = generateImplementationPlan(currentState);
            const deliverables = generateDeliverables(currentState, processName);
            const technicalApproach = generateTechnicalApproach(currentState, processName);
            
            return {
                clientInfo: {
                    companyName: clientName,
                    contactName: extractContactName(clientName), // Try to extract from company name or use default
                    address: 'Client Address\nTo be provided', // Could be extracted from other fields if available
                    date: new Date().toISOString().split('T')[0]
                },
                projectOverview: {
                    processName: processName,
                    description: `SAX Technology Advisors will design and deploy an AI-powered automation solution using Azure cloud services and n8n workflow orchestration to enhance ${processName.toLowerCase()} accessibility and efficiency.`,
                    businessObjective: projectScope.businessObjective,
                    scope: projectScope.scope,
                    deliverables: deliverables,
                    technicalApproach: technicalApproach
                },
                implementationPlan: implementationPlan,
                commercials: {
                    implementationFee: `$${implementationCost.toLocaleString()}`,
                    monthlyServiceFee: `$${monthlyServiceCost.toLocaleString()}`,
                    duration: `${totalDuration} weeks`,
                    contractLength: `${contractLength}`,
                    paymentTerms: '50% upfront, 50% upon completion'
                },
                managedServices: {
                    monthlyFee: monthlyServiceCost,
                    includes: [
                        'Complete hosting and management within the SAX Tech environment',
                        'Ongoing updates, monitoring, and optimization', 
                        'AI token costs included',
                        'System monitoring 24/7',
                        'Monthly performance optimization',
                        'Technical support included',
                        'Workflow adjustments and enhancements',
                        'Quarterly business reviews',
                        '99.5% uptime SLA'
                    ]
                },
                investmentSummary: {
                    implementationCost: `$${implementationCost.toLocaleString()}`,
                    monthlyManagedService: `$${monthlyServiceCost.toLocaleString()}`,
                    annualLaborSavings: `$${Math.round(annualLaborSavings).toLocaleString()}`,
                    timeReduction: timeSavingsPercent,
                    paybackPeriod: paybackMonths.toFixed(1),
                    firstYearROI: `${Math.round(firstYearROI)}%`,
                    partnerHoursFreed: partnerHoursFreed.toString(),
                    threeYearNetBenefit: Math.round((annualLaborSavings * 3 - totalY1Investment * 3) / (totalY1Investment * 3) * 100).toString()
                },
                riskMitigation: currentState.riskFactors?.map(risk => ({
                    risk: risk.risk,
                    mitigation: risk.mitigation
                })) || [],
                timeline: currentState.timelinePhases || timelinePhases
            };
        }
        
        // Helper function to extract contact name from company name or generate default
        function extractContactName(companyName) {
            if (!companyName || companyName === 'Your Company') {
                return 'Contact Name';
            }
            // Simple heuristic: if company name looks like "FirstName LastName" format, use it
            const words = companyName.split(' ');
            if (words.length === 2 && !words[1].toLowerCase().includes('llc') && !words[1].toLowerCase().includes('inc') && !words[1].toLowerCase().includes('corp')) {
                return companyName;
            }
            // Otherwise, generate a generic contact name based on company
            const firstWord = words[0];
            return `${firstWord} Representative`;
        }
        
        // Generate comprehensive project scope based on process analysis
        function generateProjectScope(currentState, processName) {
            const manualStepCount = currentState.manualSteps?.length || 0;
            const automationFeatures = currentState.automatedSteps?.map(step => step.feature).filter(f => f && f !== 'Automation') || [];
            const hasAI = currentState.automatedSteps?.some(step => step.isAI) || false;
            
            return {
                businessObjective: `Streamline and automate the ${processName.toLowerCase()} process to reduce manual effort by ${getCurrentTimeReduction()}%, eliminate errors, and improve processing speed while maintaining compliance and data quality.`,
                scope: [
                    `Automate ${manualStepCount} manual process steps currently requiring significant staff time`,
                    hasAI ? 'Implement AI-powered validation and decision-making capabilities' : 'Implement intelligent workflow automation',
                    'Integrate with existing business systems and databases',
                    'Provide web-based interface for process initiation and monitoring',
                    'Establish comprehensive audit trail and reporting capabilities',
                    'Ensure enterprise-grade security and compliance standards'
                ]
            };
        }
        
        // Generate implementation plan based on project complexity and timeline
        function generateImplementationPlan(currentState) {
            const phases = currentState.timelinePhases || timelinePhases;
            return phases.map(phase => ({
                phase: phase.phase,
                duration: `${phase.duration} weeks`,
                activities: phase.activities.split(',').map(a => a.trim()),
                deliverables: phase.deliverables.split(',').map(d => d.trim())
            }));
        }
        
        // Generate deliverables based on project components
        function generateDeliverables(currentState, processName) {
            const hasAI = currentState.automatedSteps?.some(step => step.isAI) || false;
            const integrationCount = currentState.automatedSteps?.filter(step => step.feature?.toLowerCase().includes('api') || step.feature?.toLowerCase().includes('integration')).length || 0;
            
            const deliverables = [
                'Complete automation workflow setup and configuration',
                'Web-based process initiation portal',
                'Azure cloud environment with enterprise security',
                'Comprehensive testing and quality assurance',
                'User training and documentation package',
                '30-day hypercare support period'
            ];
            
            if (hasAI) {
                deliverables.splice(2, 0, 'AI agent configuration and prompt optimization');
            }
            
            if (integrationCount > 0) {
                deliverables.splice(1, 0, `API integrations (${integrationCount} systems)`);
            }
            
            return deliverables;
        }
        
        // Generate technical approach based on automation features
        function generateTechnicalApproach(currentState, processName) {
            const hasAI = currentState.automatedSteps?.some(step => step.isAI) || false;
            const hasEmailAutomation = currentState.automatedSteps?.some(step => step.feature?.toLowerCase().includes('email')) || false;
            const hasDocumentProcessing = currentState.automatedSteps?.some(step => step.feature?.toLowerCase().includes('document') || step.feature?.toLowerCase().includes('filing')) || false;
            const hasWebForms = currentState.automatedSteps?.some(step => step.feature?.toLowerCase().includes('web') || step.feature?.toLowerCase().includes('form')) || false;
            
            const approach = [
                'Azure-hosted n8n workflow orchestration platform',
                'Serverless architecture using Azure Functions',
                'Enterprise-grade security with Azure Active Directory integration',
                'Comprehensive monitoring and alerting system'
            ];
            
            if (hasAI) {
                approach.splice(1, 0, 'Azure OpenAI integration for intelligent decision-making');
            }
            
            if (hasEmailAutomation) {
                approach.push('Automated email notification and communication workflows');
            }
            
            if (hasDocumentProcessing) {
                approach.push('Document processing and digital filing capabilities');
            }
            
            if (hasWebForms) {
                approach.splice(2, 0, 'Custom web forms and client portals');
            }
            
            return approach;
        }
        
        // Helper function to get current time reduction percentage
        function getCurrentTimeReduction() {
            return document.getElementById('timeSavingsPercent')?.textContent || '90';
        }
        
        // PDF Generation Function
        async function generateAndDownloadPDF(pdfData) {
            try {
                addMessage('system', 'üîÑ Generating your professional SOW PDF...');
                
                // Open the template directly in a new window/tab
                const pdfWindow = window.open('/saxtech_pdf_template.html', '_blank');
                
                if (!pdfWindow) {
                    throw new Error('Pop-up blocked. Please allow pop-ups for this site.');
                }
                
                // Wait for the window to load
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Check if the populatePDFData function exists and call it
                if (pdfWindow.populatePDFData) {
                    pdfWindow.populatePDFData(pdfData);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    // Store the data globally for the PDF window to pick up
                    window.pdfDataForTemplate = pdfData;
                }
                
                const clientName = pdfData.clientInfo?.companyName || 'Client';
                const processName = pdfData.projectOverview?.processName || 'Automation';
                const fileName = `${clientName}_${processName}_SOW.pdf`.replace(/[^a-zA-Z0-9]/g, '_');
                
                addMessage('assistant', `‚úÖ PDF window opened! Please use the browser's print function (Ctrl+P/Cmd+P) to save as PDF: ${fileName}`);
                window.lastGeneratedPDF = { data: pdfData, fileName: fileName };
                
            } catch (error) {
                console.error('PDF generation error:', error);
                addMessage('assistant', `‚ùå Error opening PDF: ${error.message}. Try using the 'Print to PDF' button above instead.`);
            }
        }
        
        window.generatePDFDownload = function(fileName) {
            if (window.lastGeneratedPDF) {
                generateAndDownloadPDF(window.lastGeneratedPDF.data);
            } else {
                alert('PDF data not found. Please regenerate the PDF.');
            }
        };
        
        // Start Over Chat function - wipes the slate clean for chat only
        function startOverChat() {
            if (confirm('This will clear all chat history and start fresh. Your ROI analysis data will remain unchanged. Continue?')) {
                // Clear chat history array
                chatHistory = [];
                
                // Reset chat interface to initial state
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="message system">
                        <div class="message-content">üëã Welcome! I'm your ROI Assistant. I'll help you analyze your automation project by asking targeted questions about your current process, costs, and automation goals.</div>
                    </div>
                `;
                
                // Reset quick actions to defaults
                const quickActions = document.getElementById('quickActions');
                quickActions.innerHTML = `
                    <div class="quick-action" onclick="sendQuickMessage('Start ROI analysis')">üöÄ Start Analysis</div>
                    <div class="quick-action" onclick="sendQuickMessage('Help me define roles')">üë• Define Roles</div>
                    <div class="quick-action" onclick="sendQuickMessage('Map current process')">üìã Map Process</div>
                    <div class="quick-action" onclick="sendQuickMessage('Calculate costs')">üí∞ Calculate Costs</div>
                `;
                
                // Clear any typing indicators
                hideTypingIndicator();
                
                // Clear input field
                const chatInput = document.getElementById('chatInput');
                chatInput.value = '';
                chatInput.style.height = 'auto';
                document.getElementById('sendBtn').disabled = true;
                
                // Send initial greeting again after a short delay
                setTimeout(() => {
                    addMessage('assistant', "Hello! I'm your ROI Assistant. I can help you analyze your automation project by asking targeted questions. What type of business process are you looking to automate?");
                }, 1000);
                
                console.log('Chat history cleared - starting fresh');
            }
        }
        
        // Validate ROI Analysis function
        function validateROIAnalysis() {
            const issues = [];
            
            // Check basic configuration
            const clientName = document.getElementById('inputClientName').value.trim();
            const processName = document.getElementById('inputProcessName').value.trim();
            const monthlyVolume = parseFloat(document.getElementById('monthlyVolume').value) || 0;
            
            if (clientName === '' || clientName === 'Your Company') {
                issues.push('Client name needs to be specified');
            }
            if (processName === '' || processName === 'Process Name') {
                issues.push('Process name needs to be specified');
            }
            if (monthlyVolume <= 0) {
                issues.push('Monthly volume must be greater than 0');
            }
            
            // Check roles
            if (roles.length === 0) {
                issues.push('At least one role must be defined');
            }
            
            // Check manual steps
            if (manualSteps.length === 0) {
                issues.push('At least one manual process step must be defined');
            }
            
            // Check automated steps
            if (automatedSteps.length === 0) {
                issues.push('At least one automated process step should be defined');
            }
            
            // Check implementation components
            if (implementationComponents.length === 0) {
                issues.push('Implementation components should be defined');
            }
            
            // Show validation results
            if (issues.length === 0) {
                addMessage('system', '‚úÖ Validation passed! Your ROI analysis looks complete and ready to present.');
                alert('‚úÖ Validation Successful!\n\nYour ROI analysis is complete and ready to present. All required fields are properly configured.');
            } else {
                const issuesList = issues.map(issue => '‚Ä¢ ' + issue).join('\n');
                addMessage('system', `‚ö†Ô∏è Validation found ${issues.length} issue(s):\n${issuesList}`);
                alert(`‚ö†Ô∏è Validation Issues Found:\n\n${issuesList}\n\nPlease address these issues before finalizing your analysis.`);
            }
        }
        
        // Generate SOP function
        function generateSOP() {
            const currentState = getCurrentROIState();
            
            if (manualSteps.length === 0) {
                alert('Please define manual process steps first before generating SOPs.');
                return;
            }
            
            // Show SOP generator panel if it exists, or create it
            let sopSection = document.getElementById('sopGeneratorSection');
            if (!sopSection) {
                createSOPGeneratorSection();
            }
            
            // Scroll to SOP section
            sopSection = document.getElementById('sopGeneratorSection');
            sopSection.scrollIntoView({ behavior: 'smooth' });
            
            // Generate SOPs based on current process
            generateSOPContent();
            
            addMessage('system', 'üìã SOP Generator opened! I\'ve analyzed your current process and generated standard operating procedures.');
        }
        
        // Create SOP Generator Section
        function createSOPGeneratorSection() {
            const container = document.querySelector('.container .content');
            
            const sopSection = document.createElement('div');
            sopSection.id = 'sopGeneratorSection';
            sopSection.className = 'section';
            sopSection.innerHTML = `
                <h2 class="section-title">9. AI-Powered SOP Generator</h2>
                
                <div class="config-panel">
                    <h3>üìã Standard Operating Procedures Generator</h3>
                    <p style="margin-bottom: 15px; color: #666;">Generate comprehensive SOPs based on your defined manual and automated processes.</p>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn-update" onclick="generateSOPContent()" style="margin: 5px;">ü§ñ Generate SOPs</button>
                        <button class="btn-update" onclick="downloadSOPs()" style="margin: 5px;">üì• Download SOPs</button>
                        <button class="btn-update" onclick="emailSOPs()" style="margin: 5px; background: #17a2b8;">üìß Email SOPs</button>
                    </div>
                    
                    <div class="sop-content">
                        <div class="sop-tabs" id="sopTabs">
                            <button class="sop-tab active" onclick="showSOPTab('current')" id="currentTab">Current Process SOP</button>
                            <button class="sop-tab" onclick="showSOPTab('automated')" id="automatedTab">Automated Process SOP</button>
                            <button class="sop-tab" onclick="showSOPTab('transition')" id="transitionTab">Transition Guide</button>
                        </div>
                        
                        <div class="sop-content-area">
                            <div id="currentSOPContent" class="sop-tab-content active">
                                <h4>Current Manual Process SOP</h4>
                                <textarea id="currentSOPText" class="workflow-textarea" placeholder="Current process SOP will be generated here..."></textarea>
                            </div>
                            
                            <div id="automatedSOPContent" class="sop-tab-content" style="display: none;">
                                <h4>Automated Process SOP</h4>
                                <textarea id="automatedSOPText" class="workflow-textarea" placeholder="Automated process SOP will be generated here..."></textarea>
                            </div>
                            
                            <div id="transitionSOPContent" class="sop-tab-content" style="display: none;">
                                <h4>Process Transition Guide</h4>
                                <textarea id="transitionSOPText" class="workflow-textarea" placeholder="Transition guide will be generated here..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-sop-options" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>üéØ SOP Customization Options</h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <label>Detail Level:</label>
                                <select id="sopDetailLevel" onchange="updateSOPSettings()">
                                    <option value="high">High Detail (Step-by-step)</option>
                                    <option value="medium" selected>Medium Detail (Key points)</option>
                                    <option value="low">Low Detail (Overview)</option>
                                </select>
                            </div>
                            <div class="config-item">
                                <label>Include Screenshots:</label>
                                <select id="sopScreenshots" onchange="updateSOPSettings()">
                                    <option value="yes">Yes (with placeholders)</option>
                                    <option value="no" selected>No</option>
                                </select>
                            </div>
                            <div class="config-item">
                                <label>Format:</label>
                                <select id="sopFormat" onchange="updateSOPSettings()">
                                    <option value="procedure" selected>Standard Procedure</option>
                                    <option value="checklist">Checklist Format</option>
                                    <option value="flowchart">Flowchart Description</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add SOP-specific CSS
            const sopStyles = document.createElement('style');
            sopStyles.innerHTML = `
                .sop-tabs {
                    display: flex;
                    border-bottom: 2px solid #dee2e6;
                    margin-bottom: 20px;
                }
                
                .sop-tab {
                    padding: 10px 20px;
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-bottom: none;
                    cursor: pointer;
                    margin-right: 5px;
                    border-radius: 5px 5px 0 0;
                }
                
                .sop-tab.active {
                    background: #fff;
                    border-color: #3498db;
                    color: #3498db;
                    font-weight: 600;
                }
                
                .sop-tab-content {
                    min-height: 400px;
                }
                
                .workflow-textarea {
                    width: 100%;
                    min-height: 400px;
                    padding: 15px;
                    border: 1px solid #dee2e6;
                    border-radius: 5px;
                    font-family: 'Courier New', monospace;
                    font-size: 0.9em;
                    background: #fff;
                }
            `;
            document.head.appendChild(sopStyles);
            
            container.appendChild(sopSection);
        }
        
        // Generate SOP Content
        function generateSOPContent() {
            const clientName = document.getElementById('inputClientName').value || 'Your Company';
            const processName = document.getElementById('inputProcessName').value || 'Process Name';
            
            // Generate Current Process SOP
            let currentSOP = generateCurrentProcessSOP(clientName, processName);
            document.getElementById('currentSOPText').value = currentSOP;
            
            // Generate Automated Process SOP
            let automatedSOP = generateAutomatedProcessSOP(clientName, processName);
            document.getElementById('automatedSOPText').value = automatedSOP;
            
            // Generate Transition Guide
            let transitionSOP = generateTransitionGuide(clientName, processName);
            document.getElementById('transitionSOPText').value = transitionSOP;
            
            addMessage('assistant', '‚úÖ SOPs generated successfully! You can review and customize them in the tabs above, then download or email them.');
        }
        
        // Generate Current Process SOP
        function generateCurrentProcessSOP(clientName, processName) {
            const date = new Date().toLocaleDateString();
            
            let sop = `STANDARD OPERATING PROCEDURE\n`;
            sop += `${clientName.toUpperCase()} - ${processName.toUpperCase()}\n`;
            sop += `Current Manual Process\n`;
            sop += `Generated: ${date}\n`;
            sop += `${'='.repeat(60)}\n\n`;
            
            sop += `PURPOSE:\n`;
            sop += `This SOP documents the current manual ${processName.toLowerCase()} process at ${clientName}.\n\n`;
            
            sop += `SCOPE:\n`;
            sop += `This procedure applies to all staff involved in ${processName.toLowerCase()} activities.\n\n`;
            
            sop += `ROLES & RESPONSIBILITIES:\n`;
            roles.forEach((role, index) => {
                sop += `${index + 1}. ${role.title} - $${role.hourly.toFixed(2)}/hour\n`;
            });
            sop += `\n`;
            
            sop += `PROCEDURE STEPS:\n`;
            manualSteps.forEach((step, index) => {
                const role = roles[step.role] || { title: 'Unknown Role' };
                sop += `${index + 1}. ${step.step}\n`;
                sop += `   Responsible Role: ${role.title}\n`;
                sop += `   Estimated Time: ${step.time} minutes\n`;
                sop += `   Cost per Instance: $${(role.hourly * step.time / 60).toFixed(2)}\n`;
                sop += `\n`;
            });
            
            // Add summary
            let totalTime = manualSteps.reduce((sum, step) => sum + step.time, 0);
            let totalCost = 0;
            manualSteps.forEach(step => {
                const role = roles[step.role];
                if (role) totalCost += (role.hourly * step.time / 60);
            });
            
            sop += `PROCESS SUMMARY:\n`;
            sop += `‚Ä¢ Total Steps: ${manualSteps.length}\n`;
            sop += `‚Ä¢ Total Time: ${totalTime} minutes (${(totalTime/60).toFixed(2)} hours)\n`;
            sop += `‚Ä¢ Total Cost per Instance: $${totalCost.toFixed(2)}\n`;
            sop += `‚Ä¢ Monthly Volume: ${document.getElementById('monthlyVolume').value} instances\n`;
            sop += `‚Ä¢ Monthly Cost: $${(totalCost * parseFloat(document.getElementById('monthlyVolume').value)).toFixed(2)}\n\n`;
            
            sop += `QUALITY CHECKPOINTS:\n`;
            sop += `‚Ä¢ Review all data entry for accuracy\n`;
            sop += `‚Ä¢ Verify required approvals are obtained\n`;
            sop += `‚Ä¢ Ensure proper documentation is maintained\n`;
            sop += `‚Ä¢ Confirm completion notifications are sent\n\n`;
            
            sop += `REVISION HISTORY:\n`;
            sop += `Version 1.0 - ${date} - Initial SOP creation\n`;
            
            return sop;
        }
        
        // Generate Automated Process SOP
        function generateAutomatedProcessSOP(clientName, processName) {
            const date = new Date().toLocaleDateString();
            
            let sop = `STANDARD OPERATING PROCEDURE\n`;
            sop += `${clientName.toUpperCase()} - ${processName.toUpperCase()}\n`;
            sop += `Automated Process with SAXTech Solution\n`;
            sop += `Generated: ${date}\n`;
            sop += `${'='.repeat(60)}\n\n`;
            
            sop += `PURPOSE:\n`;
            sop += `This SOP documents the automated ${processName.toLowerCase()} process using SAXTech's AI-powered automation solution.\n\n`;
            
            sop += `SCOPE:\n`;
            sop += `This procedure applies to all staff interfacing with the automated ${processName.toLowerCase()} system.\n\n`;
            
            sop += `SYSTEM ACCESS:\n`;
            sop += `‚Ä¢ Process Portal: [To be provided by SAXTech]\n`;
            sop += `‚Ä¢ User Authentication: Microsoft 365 SSO\n`;
            sop += `‚Ä¢ Support Contact: SAXTech Support Portal\n\n`;
            
            sop += `ROLES & RESPONSIBILITIES:\n`;
            const involvedRoles = new Set();
            automatedSteps.forEach(step => {
                if (step.role >= 0) involvedRoles.add(step.role);
            });
            Array.from(involvedRoles).forEach(roleIndex => {
                const role = roles[roleIndex];
                if (role) {
                    sop += `‚Ä¢ ${role.title} - System oversight and exception handling\n`;
                }
            });
            sop += `\n`;
            
            sop += `AUTOMATED PROCESS FLOW:\n`;
            automatedSteps.forEach((step, index) => {
                sop += `${index + 1}. ${step.step}\n`;
                if (step.role >= 0) {
                    const role = roles[step.role];
                    sop += `   Human Role: ${role ? role.title : 'Unknown'}\n`;
                    sop += `   Time Required: ${step.time} minutes\n`;
                } else {
                    sop += `   Automation: ${step.feature}\n`;
                    sop += `   Processing Time: ${step.isAI ? 'AI Processing' : 'Automated'} (~${step.time || 1} minute)\n`;
                }
                sop += `\n`;
            });
            
            // Add monitoring and exception handling
            sop += `SYSTEM MONITORING:\n`;
            sop += `‚Ä¢ Real-time dashboard available in process portal\n`;
            sop += `‚Ä¢ Automated alerts for failed processes\n`;
            sop += `‚Ä¢ Daily summary reports sent to management\n`;
            sop += `‚Ä¢ 24/7 monitoring by SAXTech operations team\n\n`;
            
            sop += `EXCEPTION HANDLING:\n`;
            sop += `‚Ä¢ System will flag exceptions requiring human review\n`;
            sop += `‚Ä¢ Notifications sent to designated staff immediately\n`;
            sop += `‚Ä¢ Manual override capabilities for authorized users\n`;
            sop += `‚Ä¢ All exceptions logged for continuous improvement\n\n`;
            
            // Add performance metrics
            let totalTime = automatedSteps.reduce((sum, step) => sum + step.time, 0);
            let manualTime = manualSteps.reduce((sum, step) => sum + step.time, 0);
            
            sop += `PERFORMANCE METRICS:\n`;
            sop += `‚Ä¢ Processing Time: ${totalTime} minutes (vs ${manualTime} manual)\n`;
            sop += `‚Ä¢ Time Savings: ${manualTime - totalTime} minutes per instance\n`;
            sop += `‚Ä¢ Accuracy Rate: 99.5%+ (AI validation)\n`;
            sop += `‚Ä¢ Availability: 99.5% uptime SLA\n\n`;
            
            sop += `ESCALATION PROCEDURES:\n`;
            sop += `1. System Issues: Contact SAXTech Support (24/7)\n`;
            sop += `2. Process Exceptions: Review with designated manager\n`;
            sop += `3. Business Rules Changes: Submit change request to SAXTech\n\n`;
            
            sop += `REVISION HISTORY:\n`;
            sop += `Version 1.0 - ${date} - Initial automated process SOP\n`;
            
            return sop;
        }
        
        // Generate Transition Guide
        function generateTransitionGuide(clientName, processName) {
            const date = new Date().toLocaleDateString();
            
            let guide = `PROCESS TRANSITION GUIDE\n`;
            guide += `${clientName.toUpperCase()} - ${processName.toUpperCase()}\n`;
            guide += `Manual to Automated Process Transition\n`;
            guide += `Generated: ${date}\n`;
            guide += `${'='.repeat(60)}\n\n`;
            
            guide += `OVERVIEW:\n`;
            guide += `This guide outlines the transition from the current manual ${processName.toLowerCase()} process to the new automated system powered by SAXTech.\n\n`;
            
            guide += `TRANSITION TIMELINE:\n`;
            timelinePhases.forEach((phase, index) => {
                guide += `Phase ${index + 1}: ${phase.phase} (${phase.duration} weeks)\n`;
                guide += `   Activities: ${phase.activities}\n`;
                guide += `   Deliverables: ${phase.deliverables}\n\n`;
            });
            
            guide += `CHANGE IMPACT ANALYSIS:\n`;
            
            // Staff impact
            guide += `STAFF IMPACT:\n`;
            const roleImpact = new Map();
            
            // Calculate current workload by role
            manualSteps.forEach(step => {
                const roleName = roles[step.role]?.title || 'Unknown';
                if (!roleImpact.has(roleName)) {
                    roleImpact.set(roleName, { current: 0, future: 0 });
                }
                roleImpact.get(roleName).current += step.time;
            });
            
            // Calculate future workload by role
            automatedSteps.forEach(step => {
                if (step.role >= 0) {
                    const roleName = roles[step.role]?.title || 'Unknown';
                    if (!roleImpact.has(roleName)) {
                        roleImpact.set(roleName, { current: 0, future: 0 });
                    }
                    roleImpact.get(roleName).future += step.time;
                }
            });
            
            roleImpact.forEach((impact, roleName) => {
                const timeSaved = impact.current - impact.future;
                const percentSaved = impact.current > 0 ? (timeSaved / impact.current * 100).toFixed(1) : 0;
                guide += `‚Ä¢ ${roleName}: ${impact.current} min ‚Üí ${impact.future} min (${timeSaved} min saved, ${percentSaved}% reduction)\n`;
            });
            guide += `\n`;
            
            guide += `TRAINING REQUIREMENTS:\n`;
            guide += `‚Ä¢ All users: 2-hour system overview session\n`;
            guide += `‚Ä¢ Process owners: 4-hour detailed training\n`;
            guide += `‚Ä¢ IT contacts: 2-hour technical briefing\n`;
            guide += `‚Ä¢ Training materials provided by SAXTech\n`;
            guide += `‚Ä¢ Hands-on practice environment available\n\n`;
            
            guide += `RISK MITIGATION:\n`;
            riskFactors.forEach((risk, index) => {
                guide += `Risk ${index + 1}: ${risk.risk}\n`;
                guide += `   Mitigation: ${risk.mitigation}\n\n`;
            });
            
            guide += `SUCCESS METRICS:\n`;
            guide += `‚Ä¢ Process completion time reduction\n`;
            guide += `‚Ä¢ Error rate improvement\n`;
            guide += `‚Ä¢ User satisfaction scores\n`;
            guide += `‚Ä¢ Cost savings realization\n`;
            guide += `‚Ä¢ System availability metrics\n\n`;
            
            guide += `COMMUNICATION PLAN:\n`;
            guide += `‚Ä¢ Week -4: Announce upcoming changes to all staff\n`;
            guide += `‚Ä¢ Week -2: Detailed briefings for affected departments\n`;
            guide += `‚Ä¢ Week -1: Final preparation and user access setup\n`;
            guide += `‚Ä¢ Go-Live: Full support available, parallel processing if needed\n`;
            guide += `‚Ä¢ Week +1,2,4: Follow-up sessions and optimization\n\n`;
            
            guide += `POST-IMPLEMENTATION SUPPORT:\n`;
            guide += `‚Ä¢ 30-day hypercare period with extended support hours\n`;
            guide += `‚Ä¢ Weekly check-ins for first month\n`;
            guide += `‚Ä¢ Monthly optimization reviews\n`;
            guide += `‚Ä¢ Ongoing SAXTech managed service support\n\n`;
            
            guide += `CONTACT INFORMATION:\n`;
            guide += `‚Ä¢ SAXTech Project Manager: [To be assigned]\n`;
            guide += `‚Ä¢ Technical Support: support@saxtechnology.com\n`;
            guide += `‚Ä¢ Emergency Escalation: [To be provided]\n\n`;
            
            guide += `REVISION HISTORY:\n`;
            guide += `Version 1.0 - ${date} - Initial transition guide\n`;
            
            return guide;
        }
        
        // SOP Tab Management
        function showSOPTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.sop-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.sop-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'SOPContent').style.display = 'block';
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // Update SOP Settings
        function updateSOPSettings() {
            // Regenerate SOPs with new settings
            generateSOPContent();
        }
        
        // Download SOPs
        function downloadSOPs() {
            const clientName = document.getElementById('inputClientName').value || 'Your Company';
            const processName = document.getElementById('inputProcessName').value || 'Process';
            const date = new Date().toISOString().split('T')[0];
            
            const currentSOP = document.getElementById('currentSOPText').value;
            const automatedSOP = document.getElementById('automatedSOPText').value;
            const transitionSOP = document.getElementById('transitionSOPText').value;
            
            const combined = `${currentSOP}\n\n${'='.repeat(80)}\n\n${automatedSOP}\n\n${'='.repeat(80)}\n\n${transitionSOP}`;
            
            const blob = new Blob([combined], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${clientName}_${processName}_SOPs_${date}.txt`.replace(/\s+/g, '_');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addMessage('assistant', 'üì• SOPs downloaded successfully! The file includes all three SOP documents.');
        }
        
        // Email SOPs (placeholder - would integrate with email service)
        function emailSOPs() {
            const currentState = getCurrentROIState();
            
            // In a real implementation, this would send via n8n webhook or email service
            // For now, we'll show a dialog with email content
            
            const clientName = currentState.clientName || 'Your Company';
            const processName = currentState.processName || 'Process';
            
            const emailContent = `Subject: ${clientName} - ${processName} Standard Operating Procedures\n\n` +
                `Dear Team,\n\n` +
                `Please find attached the Standard Operating Procedures for the ${processName} process:\n\n` +
                `‚Ä¢ Current Manual Process SOP\n` +
                `‚Ä¢ Automated Process SOP (with SAXTech solution)\n` +
                `‚Ä¢ Process Transition Guide\n\n` +
                `These documents outline the complete process transformation and should be reviewed by all stakeholders.\n\n` +
                `Best regards,\n` +
                `SAX Technology Advisors`;
            
            // Copy to clipboard and show instructions
            navigator.clipboard.writeText(emailContent).then(() => {
                alert('üìß Email content copied to clipboard!\n\nYou can now paste this into your email client. In a future version, this will integrate with your email system for direct sending.');
                addMessage('assistant', 'üìß Email content prepared and copied to clipboard. You can now paste it into your email client.');
            }).catch(() => {
                alert('Email feature coming soon! For now, please use the Download SOPs button.');
            });
        }
        
        // Initialize everything when page loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            initializeChat();
            renderAll();
            updateCalculations();
        });
    </script>
    
    <!-- Authentication Status Widget -->
    <script src="auth-widget.js"></script>
</body>
</html>
